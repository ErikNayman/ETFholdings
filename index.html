<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ETF Holdings → Copy-Paste</title>
  <style>
    body { font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    select, button { padding:8px 12px; font: inherit; }
    table { border-collapse: collapse; margin-top: 12px; width: 100%; max-width: 960px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f6f6f6; }
    .muted { color:#666; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>ETF Holdings → Copy-Paste</h1>
  <div class="row">
    <label for="etf">ETF:</label>
    <select id="etf"></select>
    <button id="copy">Скопировать таблицу</button>
    <a id="download" class="muted" href="#" download>Скачать CSV</a>
    <span id="stamp" class="muted"></span>
  </div>

  <table id="tbl" hidden>
    <thead><tr><th>Ticker</th><th>Weight</th></tr></thead>
    <tbody></tbody>
  </table>

  <p id="msg" class="muted"></p>

  <script>
    const $etf = document.getElementById('etf');
    const $tbl = document.getElementById('tbl');
    const $tbody = $tbl.querySelector('tbody');
    const $copy = document.getElementById('copy');
    const $dl = document.getElementById('download');
    const $stamp = document.getElementById('stamp');
    const $msg = document.getElementById('msg');

    const fmtPct = (x) => {
      const n = +x;
      return Number.isFinite(n) ? (n*100).toFixed(4) + '%' : x;
    };

    async function loadIndex() {
      const r = await fetch('./data/_index.json', {cache:'no-cache'});
      if (!r.ok) throw new Error('Нет файла data/_index.json. Сначала запустите сборку.');
      return r.json();
    }

    async function loadCSV(ticker) {
      const url = `./data/${ticker.toUpperCase()}.csv`;
      const r = await fetch(url, {cache:'no-cache'});
      if (!r.ok) throw new Error(`Нет файла ${url}. Проверьте конфиг/сборку.`);
      const text = await r.text();
      return Papa.parse(text.trim(), { header: true }).data;
    }

    function render(rows) {
      $tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        const td2 = document.createElement('td');
        td1.textContent = r.Ticker ?? r.ticker ?? '';
        td2.textContent = fmtPct(r.Weight ?? r.weight);
        tr.append(td1, td2);
        $tbody.appendChild(tr);
      });
      $tbl.hidden = rows.length === 0;
      $msg.textContent = rows.length ? `Всего: ${rows.length}` : 'Пусто';
    }

    function copyTable() {
      const rows = [['Ticker','Weight']];
      for (const tr of $tbody.querySelectorAll('tr')) {
        rows.push([
          tr.children[0].textContent,
          tr.children[1].textContent
        ]);
      }
      const tsv = rows.map(r => r.join('\t')).join('\n');
      navigator.clipboard.writeText(tsv).then(()=>{
        $msg.textContent = 'Скопировано в буфер как TSV — вставляйте в Google Sheets.';
      });
    }

    loadIndex().then(idx => {
      idx.tickers.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = t;
        $etf.appendChild(opt);
      });
      $stamp.textContent = idx.updatedAt ? 'Обновлено: ' + new Date(idx.updatedAt).toLocaleString() : '';
      if (idx.tickers.length) {
        $etf.value = idx.tickers[0];
        $etf.dispatchEvent(new Event('change'));
      }
    }).catch(e => { $msg.textContent = e.message; });

    $etf.addEventListener('change', async () => {
      const t = $etf.value;
      try {
        const rows = await loadCSV(t);
        render(rows);
        $dl.href = `./data/${t}.csv`;
        $dl.download = `${t}.csv`;
      } catch (e) {
        $msg.textContent = e.message;
        render([]);
        $dl.removeAttribute('href');
      }
    });

    $copy.addEventListener('click', copyTable);
  </script>
</body>
</html>
