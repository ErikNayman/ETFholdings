<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCF Pro: Lifecycle & Targets</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; }
        input[type=range]:focus { outline: none; }
        .chart-container { position: relative; width: 100%; height: 280px; }
        .lc-chart-container { position: relative; width: 100%; height: 220px; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        
        /* Timeline styling */
        .timeline-line { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: #e2e8f0; z-index: 0; transform: translateY(-50%); }
        .timeline-segment { flex: 1; text-align: center; position: relative; padding-top: 20px; }
        .timeline-dot { width: 12px; height: 12px; border-radius: 50%; background: white; border: 2px solid #64748b; margin: 0 auto; position: relative; z-index: 10; }
        .timeline-segment.active .timeline-dot { border-color: #3b82f6; background: #eff6ff; }
        
        .dur-badge { 
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%); 
            font-size: 0.65rem; background: #f1f5f9; padding: 1px 6px; border-radius: 99px; 
            border: 1px solid #cbd5e1; color: #64748b; font-weight: 600; z-index: 5;
        }

        @keyframes flash {
            0% { background-color: #dbeafe; }
            100% { background-color: white; }
        }
        .flash-update {
            animation: flash 1s ease-out;
        }
    </style>
</head>
<body class="antialiased">

    <div class="max-w-7xl mx-auto px-4 py-6">

        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">DCF Pro: Lifecycle Engine</h1>
                <p class="text-sm text-slate-500">
                    Оценка стоимости, сценарный анализ и жизненный цикл компании.
                </p>
            </div>
            <div class="text-right">
                <div class="text-xs text-slate-400 uppercase">Метрика</div>
                <div class="text-sm font-bold text-indigo-600">IRR vs Cost of Capital (r)</div>
            </div>
        </header>

        <div class="grid lg:grid-cols-12 gap-6">

            <!-- LEFT COLUMN: CONTROLS -->
            <div class="lg:col-span-4 space-y-5">
                
                <!-- DATA SOURCE PANEL -->
                <div class="bg-indigo-600 rounded-xl shadow-lg p-4 text-white">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-indigo-200 uppercase tracking-wider">Источник данных</label>
                        <span id="db-status" class="text-[10px] bg-indigo-500 px-2 py-0.5 rounded text-indigo-100">Демо База</span>
                    </div>

                    <!-- Excel Upload -->
                    <div class="mb-4 relative group">
                        <label for="excel-upload" class="flex items-center justify-center w-full px-4 py-2 bg-indigo-500 hover:bg-indigo-400 border border-indigo-400 border-dashed rounded cursor-pointer transition-colors text-xs font-bold uppercase select-none">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            Загрузить Excel (.xlsx)
                        </label>
                        <input id="excel-upload" type="file" accept=".xlsx, .xls" class="hidden" onchange="handleExcelUpload(event)">
                        <div class="hidden group-hover:block absolute top-full left-0 w-full bg-slate-800 text-slate-200 text-[10px] p-3 rounded mt-1 z-20 shadow-xl border border-slate-600 leading-relaxed">
                            <strong>Нужные колонки:</strong><br>
                            Ticker, Price, RPS, Growth, Margin, WACC, Payout<br>
                            <em class="text-slate-400">Опционально: Theme, N (срок)</em>
                        </div>
                    </div>
                    <div id="upload-error" class="text-xs bg-red-500 text-white p-2 rounded mb-2 hidden"></div>

                    <!-- Search -->
                    <div class="flex gap-2">
                        <input type="text" id="inp-ticker" placeholder="TICKER (e.g. SPY, QQQ)" class="w-full bg-indigo-700 border border-indigo-500 text-white placeholder-indigo-300 rounded px-3 py-2 font-bold uppercase focus:outline-none focus:ring-2 focus:ring-white">
                        <button onclick="loadTicker()" class="bg-white text-indigo-600 px-4 py-2 rounded font-bold hover:bg-indigo-50 transition-colors">Go</button>
                    </div>
                    <div id="ticker-error" class="text-xs text-red-300 mt-2 hidden">Тикер не найден</div>
                </div>

                <!-- INPUTS -->
                <div id="inputs-panel" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 border-l-4 border-l-slate-400 transition-colors duration-500">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-700 uppercase">1. Параметры Входа</h3>
                        <div class="flex items-center gap-2">
                            <!-- NEW: RESET BUTTON -->
                            <button onclick="resetToDefaults()" id="btn-reset" class="text-[10px] font-bold text-indigo-600 hover:text-indigo-800 uppercase bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100 transition-colors hidden" title="Вернуть исходные значения">
                                ↺ Сброс
                            </button>
                            <span id="company-name" class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded">Custom</span>
                        </div>
                    </div>
                    
                    <label class="block text-[10px] font-bold text-slate-400 mb-1">ПРОФИЛЬ БИЗНЕСА (АВТО)</label>
                    <select id="theme-selector" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-slate-50 font-medium mb-3">
                        <option value="Rocket">Rocket Growth (Startups)</option>
                        <option value="Expansion">Expansion Compounder (NVDA)</option>
                        <option value="IndexTech">Index Tech / Growth (QQQ)</option>
                        <option value="Momentum">Quality Momentum (AAPL)</option>
                        <option value="Steady">Steady Compounder (SPY)</option>
                        <option value="IndexValue">Index Value / Blue Chip (DIA)</option>
                        <option value="Dividend">Dividend Stability (JPM)</option>
                        <option value="Fallen">Fallen Angel (PYPL)</option>
                        <option value="DeepValue">Deep Value (GM)</option>
                    </select>

                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-700">Цена Акции ($)</label>
                            <input type="number" id="inp-price" class="w-full border-2 border-blue-100 p-2 rounded font-bold text-blue-800 text-lg" value="150">
                        </div>

                        <div>
                            <label class="block text-xs text-slate-400">RPS ($)</label>
                            <input type="number" id="inp-rps" class="w-full border p-1 rounded" value="20">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400">Рост (%)</label>
                            <input type="number" id="inp-growth" class="w-full border p-1 rounded font-bold text-green-600" value="10">
                        </div>
                        
                        <div class="col-span-2 bg-yellow-50 p-2 rounded border border-yellow-100">
                            <label class="block text-xs font-bold text-yellow-800">Прогноз Маржи (2025-27)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="inp-forecast-margin" class="w-full bg-white border p-1 rounded font-bold text-slate-700" value="15.0">
                                <span class="text-xs text-slate-500">%</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs text-slate-400">Стоимость капитала (r, %)</label>
                            <input type="number" id="inp-wacc" class="w-full border p-1 rounded" value="8" step="0.1" min="0">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 font-bold text-purple-600">Нач. Payout (%)</label>
                            <input type="number" id="inp-payout" class="w-full border-2 border-purple-100 p-1 rounded font-bold text-purple-700" value="30">
                        </div>
                    </div>
                </div>

                <!-- SCENARIO & RESULTS -->
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-4 ring-1 ring-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 uppercase mb-3">2. Сценарный Двигатель</h3>
                    <div class="flex space-x-2 mb-6">
                        <button onclick="setScenario('pessimistic')" id="btn-pessimistic" class="flex-1 py-3 text-xs border rounded-lg hover:bg-red-50 transition-all font-medium text-slate-600">Пессимизм</button>
                        <button onclick="setScenario('base')" id="btn-base" class="flex-1 py-3 text-xs bg-blue-600 text-white rounded-lg shadow-md transition-all font-bold">Базовый</button>
                        <button onclick="setScenario('optimistic')" id="btn-optimistic" class="flex-1 py-3 text-xs border rounded-lg hover:bg-green-50 transition-all font-medium text-slate-600">Оптимизм</button>
                    </div>
                    
                    <div class="mt-6 mb-2">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-bold text-slate-500">Общий горизонт (N)</label>
                            <span id="disp-years" class="text-xs font-bold text-blue-600">-- лет</span>
                        </div>
                        <input type="range" id="slider-years" min="5" max="35" step="1" class="w-full h-1.5 bg-slate-200 rounded-lg accent-blue-600">
                    </div>
                </div>

                <div class="bg-slate-800 rounded-xl p-5 text-white shadow-xl">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest">IRR (Прогноз)</h4>
                            <div class="text-5xl font-bold tracking-tight" id="res-irr">--%</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-slate-400 uppercase">Upside</div>
                            <div id="res-upside" class="text-xl font-bold text-green-400">--%</div>
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-2 border-t border-slate-600 text-[10px] text-slate-400 flex justify-between">
                        <span>Fair Value: <span id="res-fv" class="text-white font-bold">$---</span></span>
                        <span>Exit P/E: <span id="res-exit-pe" class="text-white font-bold">--x</span></span>
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: VISUALS -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- CASH FLOW CHART -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-slate-700">Траектория Денежных Потоков</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="cfChart"></canvas>
                    </div>
                </div>

                <!-- LIFECYCLE CHART & METRICS -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <h3 class="text-sm font-bold text-slate-700 mb-4">Жизненный Цикл и Целевые Показатели</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Chart -->
                        <div>
                            <div class="lc-chart-container">
                                <canvas id="lifecycleChart"></canvas>
                            </div>
                            <div class="text-center text-[10px] text-slate-400 mt-2 italic">
                                Показывает положение компании в 3-х сценариях
                            </div>
                        </div>

                        <!-- Targets Table -->
                        <div class="flex flex-col justify-center">
                            <table class="w-full text-sm text-left border-collapse">
                                <thead>
                                    <tr class="text-[10px] uppercase text-slate-400 border-b border-slate-100">
                                        <th class="py-2 pl-2">Показатель</th>
                                        <th class="py-2 text-right">Текущий</th>
                                        <th class="py-2 text-right text-blue-600 font-bold">Цель (Mid)</th>
                                        <th class="py-2 text-right text-slate-500">Терминал</th>
                                    </tr>
                                </thead>
                                <tbody id="lifecycle-table-body" class="text-xs font-medium divide-y divide-slate-50">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                            <div class="mt-3 text-[10px] text-slate-400 bg-slate-50 p-2 rounded">
                                <strong>Как читать:</strong> Модель плавно интерполирует значения от "Текущих" к "Целевым" (фаза роста) и затем к "Терминальным" (зрелость).
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SENSITIVITY MATRIX -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <div class="flex justify-between items-end mb-2">
                        <h4 class="text-xs font-bold text-slate-700 uppercase tracking-widest">Матрица Справедливой Цены (PV Today)</h4>
                        <span class="text-[10px] text-slate-500">Влияние ставки (r) и мультипликатора (P/E)</span>
                    </div>
                    <div class="grid grid-cols-4 gap-1 text-center select-none" id="sens-grid">
                        <!-- JS Generated -->
                    </div>
                </div>

                <!-- CALCULATION DETAILS TABLE -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex justify-between">
                        <h3 class="text-sm font-bold text-slate-700">Детализация Расчета</h3>
                        <span class="text-xs text-slate-400">Номинальные значения ($)</span>
                    </div>
                    <div class="overflow-x-auto custom-scroll" style="max-height: 350px;">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 uppercase bg-white sticky top-0 border-b">
                                <tr>
                                    <th class="px-4 py-2">Год</th>
                                    <th class="px-4 py-2">Фаза</th>
                                    <th class="px-4 py-2 text-right">RPS</th>
                                    <th class="px-4 py-2 text-right">Маржа</th>
                                    <th class="px-4 py-2 text-right">EPS</th>
                                    <th class="px-4 py-2 text-right text-purple-600">Payout</th>
                                    <th class="px-4 py-2 text-right font-bold text-blue-600">Flow</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            ANALYST_YEARS: 2,
            DEFAULT_WACC: 0.08,
            IRR_MAX_ITER: 1000,
            IRR_TOL: 1e-6,
            IRR_MIN_RATE: -0.99,
            IRR_MAX_RATE: 5
        };

        const THEME_ORDER = ['Rocket', 'Expansion', 'IndexTech', 'Momentum', 'Steady', 'IndexValue', 'Dividend', 'DeepValue', 'Fallen'];
        
        // --- DEMO DATABASE (UPDATED WITH PROFILES) ---
        const DEMO_DB = {
            'SPY': { name: 'S&P 500 ETF', price: 683.39, rps: 200.7, growth: 8.2, margin: 14.9, wacc: 8.0, payout: 27.1, profile: 'Steady' }, 
            'QQQ': { name: 'Invesco QQQ (Nasdaq)', price: 445.0, rps: 130.5, growth: 11.0, margin: 19.5, wacc: 8.5, payout: 10, profile: 'IndexTech' }, 
            'DIA': { name: 'SPDR Dow Jones', price: 395.0, rps: 280.0, growth: 6.5, margin: 12.5, wacc: 7.5, payout: 35, profile: 'IndexValue' }, 
            'AAPL': { name: 'Apple Inc.', price: 189.5, rps: 24.5, growth: 6.5, margin: 26.5, wacc: 8.5, payout: 15 },
            'NVDA': { name: 'Nvidia Corp', price: 880.0, rps: 24.8, growth: 65.0, margin: 55.0, wacc: 9.0, payout: 2 },
            'TSLA': { name: 'Tesla Inc', price: 175.2, rps: 30.1, growth: 15.0, margin: 10.5, wacc: 10.5, payout: 0 },
            'MSFT': { name: 'Microsoft', price: 420.0, rps: 31.5, growth: 12.0, margin: 36.0, wacc: 8.0, payout: 25 },
            'AMZN': { name: 'Amazon', price: 178.0, rps: 55.0, growth: 11.0, margin: 6.5, wacc: 9.0, payout: 0 },
            'GOOGL': { name: 'Alphabet', price: 173.0, rps: 24.0, growth: 10.0, margin: 24.0, wacc: 8.5, payout: 10 }
        };

        // Current Active DB
        let GLOBAL_DB = { ...DEMO_DB };

        const METRICS = {
            'Rocket':    { name: 'Rocket',    growth: 40,    margin: 5,    pe: 75,  payout: 0,  N: 20, lcX: 15 }, 
            'Expansion': { name: 'Expansion', growth: 20.0, margin: 33.7, pe: 24.3, payout: 15, N: 15, lcX: 30 }, 
            'IndexTech': { name: 'Index Tech',growth: 11.0, margin: 21.0, pe: 25.0, payout: 15, N: 15, lcX: 40 }, 
            'Momentum':  { name: 'Momentum',  growth: 14.3, margin: 27.8, pe: 22.7, payout: 50, N: 12, lcX: 55 }, 
            'Steady':    { name: 'Steady',    growth: 7.9,  margin: 12.5, pe: 21.6, payout: 45, N: 12, lcX: 65 }, 
            'IndexValue':{ name: 'Index Value',growth: 6.5, margin: 12.5, pe: 19.5, payout: 40, N: 12, lcX: 75 }, // Updated: PE 17.5->19.5, Growth 5.5->6.5
            'Dividend':  { name: 'Dividend',  growth: 6.0,  margin: 14.8, pe: 13.9, payout: 75, N: 9,  lcX: 85 },
            'DeepValue': { name: 'Value',     growth: 2.7,  margin: 12.3, pe: 10.9, payout: 50, N: 6,  lcX: 95 },
            'Fallen':    { name: 'Fallen',    growth: 22.4, margin: 6.5,  pe: 11.8, payout: 30, N: 9,  lcX: 90 } 
        };

        const BASE_CHAINS = {
            'Rocket':    ['Rocket', 'Expansion', 'Momentum'],
            'Expansion': ['Expansion', 'Momentum', 'Steady'],
            'IndexTech': ['IndexTech', 'Momentum', 'Steady'], // Default decay if not index
            'Momentum':  ['Momentum', 'Steady', 'Dividend'],
            'Steady':    ['Steady', 'Dividend', 'DeepValue'],
            'IndexValue':['IndexValue', 'Dividend', 'DeepValue'],
            'Dividend':  ['Dividend', 'DeepValue', 'DeepValue'],
            'Fallen':    ['Fallen', 'DeepValue', 'Steady'],
            'DeepValue': ['DeepValue', 'Steady', 'Dividend']
        };

        const EDGE_MODS = {
            rocket_opt: { pe: 1.25, margin: 1.2, growth: 1.1 },
            deep_pess:  { pe: 0.8,  margin: 0.8, growth: 0.8 }
        };

        let state = { scenario: 'base', charts: {}, userSetYears: false, currentTicker: '' };

        // --- EXCEL LOGIC ---
        function handleExcelUpload(e) {
            const errEl = document.getElementById('upload-error');
            errEl.classList.add('hidden');
            
            if (typeof XLSX === 'undefined') {
                errEl.innerText = "Ошибка: Библиотека Excel не загрузилась.";
                errEl.classList.remove('hidden');
                return;
            }

            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    let successCount = 0;
                    for (const sheetName of workbook.SheetNames) {
                        const worksheet = workbook.Sheets[sheetName];
                        const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        const res = extractDataFromSheet(rawData);
                        if (res && res.count > 0) {
                            GLOBAL_DB = { ...GLOBAL_DB, ...res.db };
                            successCount += res.count;
                        }
                    }

                    if (successCount > 0) {
                        document.getElementById('db-status').innerText = `Excel (${successCount} шт.)`;
                        document.getElementById('db-status').className = "text-[10px] bg-green-500 px-2 py-0.5 rounded text-white";
                        alert(`Успешно загружено ${successCount} компаний! Введите тикер в поиск.`);
                    } else {
                        errEl.innerText = "Не удалось найти данные. Проверьте заголовки (Ticker, Price...).";
                        errEl.classList.remove('hidden');
                    }

                } catch (err) {
                    console.error(err);
                    errEl.innerText = "Ошибка чтения файла.";
                    errEl.classList.remove('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function normalizeTheme(raw) {
            if (!raw) return null;
            const str = String(raw).toLowerCase().trim();
            const keys = Object.keys(METRICS);
            const exact = keys.find(k => k.toLowerCase() === str);
            if (exact) return exact;
            
            if (str.includes('nasdaq') || str.includes('qqq') || str.includes('tech index')) return 'IndexTech';
            if (str.includes('dow') || str.includes('dia') || str.includes('value index')) return 'IndexValue';
            
            if (str.includes('rocket') || str.includes('start')) return 'Rocket';
            if (str.includes('expansion') || str.includes('nvda')) return 'Expansion';
            if (str.includes('momentum') || str.includes('quality')) return 'Momentum';
            if (str.includes('steady') || str.includes('compounder')) return 'Steady';
            if (str.includes('dividend') || str.includes('yield')) return 'Dividend';
            if (str.includes('deep') || str.includes('value')) return 'DeepValue';
            if (str.includes('fallen')) return 'Fallen';
            return null;
        }

        function extractDataFromSheet(rows) {
            const newDB = {};
            let count = 0;
            if (!rows || rows.length === 0) return { count: 0, db: {} };

            let headerRowIndex = -1;
            let colMap = {}; 
            // IMPROVED KEYMAP: Removed ambiguous short keys like 'r', 'g'
            // Added 'n' / 'term' for custom years
            const keyMap = {
                ticker: ['ticker', 'symbol', 'code', 'тикер'],
                price: ['price', 'close', 'last', 'цена'],
                rps: ['rps', 'revenue', 'sales', 'выручка'], 
                growth: ['growth', 'cagr', 'рост'], 
                margin: ['margin', 'маржа'],
                wacc: ['wacc', 'cost of capital', 'ставка', 'ks'], 
                payout: ['payout', 'dividen', 'дивиден'], 
                theme: ['theme', 'profile', 'strategy', 'тема'],
                n: ['n', 'years', 'term', 'srok', 'срок', 'horizon'] // NEW: Custom N
            };

            for (let i = 0; i < Math.min(rows.length, 20); i++) {
                const row = rows[i];
                let tempMap = {};
                row.forEach((cell, cellIdx) => {
                    if (!cell) return;
                    const val = String(cell).toLowerCase().trim();
                    for (const [key, candidates] of Object.entries(keyMap)) {
                        if (candidates.some(c => val.includes(c))) {
                            if (tempMap[key] === undefined) tempMap[key] = cellIdx;
                        }
                    }
                });
                if (tempMap.ticker !== undefined && tempMap.price !== undefined) {
                    headerRowIndex = i; colMap = tempMap; break;
                }
            }

            if (headerRowIndex === -1) return { count: 0, db: {} };

            for (let i = headerRowIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                const getValue = (key) => {
                    const idx = colMap[key];
                    return idx !== undefined ? row[idx] : null;
                };
                const rawTicker = getValue('ticker');
                const rawPrice = getValue('price');

                if (rawTicker && rawPrice) {
                    const ticker = String(rawTicker).trim().toUpperCase();
                    
                    const safeFloat = (val, def) => {
                        const parsed = parseFloat(val);
                        return isNaN(parsed) ? def : parsed;
                    };

                    const nVal = safeFloat(getValue('n'), null);

                    newDB[ticker] = {
                        name: ticker + ' (Excel)',
                        price: safeFloat(rawPrice, 0),
                        rps: safeFloat(getValue('rps'), 10),
                        growth: safeFloat(getValue('growth'), 5),
                        margin: safeFloat(getValue('margin'), 10),
                        wacc: safeFloat(getValue('wacc'), 8), 
                        payout: safeFloat(getValue('payout'), 0),
                        profile: normalizeTheme(getValue('theme')),
                        n_term: nVal // Store custom N
                    };
                    count++;
                }
            }
            return { count, db: newDB };
        }

        // --- AUTO-PROFILE ---
        function detectProfile(data) {
            const g = data.growth;
            const m = data.margin;
            const p = data.payout;
            // Heuristics
            if (data.name && data.name.includes('Nasdaq')) return 'IndexTech';
            if (data.name && data.name.includes('Dow')) return 'IndexValue';
            
            if (g > 30) return 'Rocket';
            if (g > 15 && m > 20) return 'Expansion';
            if (g > 10 && m > 15 && p > 10) return 'Momentum';
            if (p > 60) return 'Dividend';
            if (g < 5 && p > 0) return 'DeepValue';
            if (g > 15 && m < 10) return 'Fallen';
            return 'Steady'; 
        }

        function loadTicker() {
            const inputEl = document.getElementById('inp-ticker');
            const errorEl = document.getElementById('ticker-error');
            const panelEl = document.getElementById('inputs-panel');
            const rawTicker = inputEl.value.trim().toUpperCase();

            errorEl.classList.add('hidden');
            
            if (GLOBAL_DB[rawTicker]) {
                const data = GLOBAL_DB[rawTicker];
                state.currentTicker = rawTicker; // Store loaded ticker
                
                document.getElementById('inp-price').value = data.price;
                document.getElementById('inp-rps').value = data.rps;
                document.getElementById('inp-growth').value = data.growth;
                document.getElementById('inp-forecast-margin').value = data.margin;
                document.getElementById('inp-wacc').value = data.wacc;
                document.getElementById('inp-payout').value = data.payout;
                
                const profile = data.profile || detectProfile(data);
                document.getElementById('theme-selector').value = profile;
                safeSetText('company-name', data.name || rawTicker);

                // Show Reset Button
                document.getElementById('btn-reset').classList.remove('hidden');

                // Handle custom N
                const slider = document.getElementById('slider-years');
                if (data.n_term && data.n_term > 0) {
                    slider.value = Math.min(Math.max(data.n_term, 5), 35); // Clamp 5-35
                    state.userSetYears = true;
                } else {
                    state.userSetYears = false; // Reset so default theme N applies
                }

                panelEl.classList.add('flash-update');
                setTimeout(() => panelEl.classList.remove('flash-update'), 1000);
                state.scenario = 'base'; 
                setScenario('base'); 
            } else {
                errorEl.classList.remove('hidden');
                errorEl.innerText = `Тикер "${rawTicker}" не найден.`;
                document.getElementById('btn-reset').classList.add('hidden');
            }
        }
        
        // --- RESET INPUTS FUNCTION ---
        function resetToDefaults() {
            if (!state.currentTicker || !GLOBAL_DB[state.currentTicker]) return;
            
            const data = GLOBAL_DB[state.currentTicker];
            
            // 1. Reset Input Fields
            document.getElementById('inp-price').value = data.price;
            document.getElementById('inp-rps').value = data.rps;
            document.getElementById('inp-growth').value = data.growth;
            document.getElementById('inp-forecast-margin').value = data.margin;
            document.getElementById('inp-wacc').value = data.wacc;
            document.getElementById('inp-payout').value = data.payout;
            
            // 2. Reset Profile
            const profile = data.profile || detectProfile(data);
            document.getElementById('theme-selector').value = profile;
            
            // 3. Reset Horizon (N)
            const slider = document.getElementById('slider-years');
            if (data.n_term && data.n_term > 0) {
                slider.value = Math.min(Math.max(data.n_term, 5), 35); 
                state.userSetYears = true;
            } else {
                state.userSetYears = false; 
                // Will be auto-set by setScenario->getScenarioHorizon logic for base
            }
            
            // 4. Visual Feedback & Recalc
            const panel = document.getElementById('inputs-panel');
            panel.classList.remove('flash-update');
            void panel.offsetWidth; // trigger reflow
            panel.classList.add('flash-update');
            
            state.scenario = 'base';
            setScenario('base');
        }

        // --- HELPERS ---
        function safeSetText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }
        function formatCurrency(n) { return n == null || !isFinite(n) ? '$---' : n.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }); }
        function formatPercent(n) { return n == null || !isFinite(n) ? '--%' : n.toFixed(1) + '%'; }
        function clamp(v, min, max) { return Math.min(max, Math.max(min, v)); }

        // --- SCENARIO HORIZON HELPER ---
        function getScenarioHorizon(baseN, scenario) {
            const minN = 5;
            const maxN = 30; // Changed from 35 to 30 as suggested

            if (scenario === 'optimistic') {
                // +20% horizon, roughly
                return clamp(Math.round(baseN * 1.2), minN, maxN);
            }
            if (scenario === 'pessimistic') {
                // -20% horizon, roughly
                return clamp(Math.round(baseN * 0.8), minN, maxN);
            }
            // base
            return clamp(baseN, minN, maxN);
        }

        // --- CALC PARAMS ---
        function getCalcParams(selected, scenario, ticker) {
            let res = { themeKey: selected, mods: { pe: 1, margin: 1, growth: 1 }, chain: [] };
            
            // --- INDEX EXCEPTIONS: SPECIFIC LIFECYCLES ---
            if (['SPY', 'QQQ', 'DIA'].includes(ticker)) {
                
                if (ticker === 'QQQ') {
                    res.chain = ['IndexTech', 'IndexTech', 'Steady'];
                }
                else if (ticker === 'DIA') {
                    res.chain = ['IndexValue', 'IndexValue', 'IndexValue'];
                }
                else {
                    res.chain = ['Steady', 'Steady', 'Steady'];
                }
                
                if (scenario === 'optimistic') res.mods = { pe: 1.1, margin: 1.05, growth: 1.05 };
                else if (scenario === 'pessimistic') res.mods = { pe: 0.9, margin: 0.95, growth: 0.95 };
                
                return res;
            }

            // Normal Logic for individual stocks
            let startKey = selected;
            
            if (selected === 'Rocket' && scenario === 'optimistic') res.mods = EDGE_MODS.rocket_opt; 
            else if (selected === 'DeepValue' && scenario === 'pessimistic') res.mods = EDGE_MODS.deep_pess; 
            else if (selected === 'Expansion' && scenario === 'optimistic') {
                // Expansion optimistic logic: stay Expansion but boost metrics
                res.chain = ['Expansion', 'Expansion', 'Momentum'];
                res.mods = { pe: 1.3, margin: 1.15, growth: 1.2 }; 
                return res;
            }
            else if (selected === 'Expansion' && scenario === 'base') {
                // Dampen Expansion base growth slightly
                res.mods = { pe: 1, margin: 1, growth: 0.9 };
            }
            else if (selected === 'Fallen') {
                if (scenario === 'optimistic') startKey = 'Expansion';
                if (scenario === 'pessimistic') startKey = 'DeepValue';
            } else if (scenario === 'optimistic') {
                const idx = THEME_ORDER.indexOf(selected);
                if (idx > 0) startKey = THEME_ORDER[idx - 1];
            } else if (scenario === 'pessimistic') {
                const idx = THEME_ORDER.indexOf(selected);
                if (idx < THEME_ORDER.length - 1) startKey = THEME_ORDER[idx + 1];
            }

            res.themeKey = startKey;
            res.chain = BASE_CHAINS[startKey] || ['Steady', 'Dividend', 'DeepValue'];
            return res;
        }

        // --- IRR ---
        function calculateIRR(values) {
            const hasPos = values.some(v => v > 0);
            const hasNeg = values.some(v => v < 0);
            if (!hasPos || !hasNeg) return null; 
            const maxIter = CONFIG.IRR_MAX_ITER, tol = CONFIG.IRR_TOL;
            let rate = 0.1;

            for (let i = 0; i < maxIter; i++) {
                let npv = 0, d_npv = 0;
                const onePlus = 1 + rate;
                if (onePlus <= 0) break;
                for (let j = 0; j < values.length; j++) {
                    const div = Math.pow(onePlus, j);
                    npv += values[j] / div;
                    d_npv -= (j * values[j]) / (div * onePlus);
                }
                if (Math.abs(npv) < tol) return rate;
                if (d_npv === 0 || !isFinite(d_npv)) break;
                const newRate = rate - (npv / d_npv);
                if (!isFinite(newRate)) break;
                if (Math.abs(newRate - rate) < tol) return newRate;
                rate = newRate;
                if (rate < CONFIG.IRR_MIN_RATE || rate > CONFIG.IRR_MAX_RATE) break;
            }
            return null; 
        }

        // --- CORE MODEL ---
        function runDCFModel(inputs, userThemeKey, scenario, overrides = {}) {
            const { startPrice, startRPS, startGrowth, forecastMargin, wacc, startPayout, N } = inputs;
            
            // Pass ticker to params to check for SPY/Indices
            const params = getCalcParams(userThemeKey, scenario, state.currentTicker);
            
            const mods = params.mods;
            const chainKeys = params.chain;

            const t1 = METRICS[chainKeys[0]];
            const t2 = METRICS[chainKeys[1]];
            const t3 = METRICS[chainKeys[2]];

            // Logic to determine Phase Targets for Display
            const phaseTargets = {
                current: { g: startGrowth, m: forecastMargin, p: startPayout },
                mid: { g: t1.growth * mods.growth, m: t1.margin * mods.margin, p: t1.payout },
                term: { g: t3.growth * mods.growth, m: t3.margin * mods.margin, p: t3.payout }
            };

            const modelYears = Math.max(1, N - CONFIG.ANALYST_YEARS);
            
            // Calculate phase durations
            let p1_dur = Math.floor(modelYears / 3);
            let p2_dur = Math.floor(modelYears / 3);
            let p3_dur = modelYears - p1_dur - p2_dur;

            // Cap Phase 1 and Phase 2 to max 5 years each
            // Additional restriction for high growth profiles
            const highGrowthProfiles = ['Rocket', 'Expansion'];
            if (highGrowthProfiles.includes(params.themeKey)) {
                const maxHighGrowthYears = 5; 
                const total12 = p1_dur + p2_dur;
                if (total12 > maxHighGrowthYears) {
                    const scale = maxHighGrowthYears / total12;
                    p1_dur = Math.max(1, Math.round(p1_dur * scale));
                    p2_dur = Math.max(1, Math.round(p2_dur * scale));
                    p3_dur = modelYears - p1_dur - p2_dur;
                }
            } else {
                // Standard capping
                p1_dur = Math.min(5, p1_dur);
                p2_dur = Math.min(5, p2_dur);
                p3_dur = modelYears - p1_dur - p2_dur;
            }
            
            // Scenario PE adjustment - Decoupled from WACC/Gordon for stability
            let scenarioPEAdj = 1.0;
            if (scenario === 'optimistic') scenarioPEAdj = 1.15;   
            if (scenario === 'pessimistic') scenarioPEAdj = 0.85;  

            // CHANGED: Use let so it can be reassigned if overrides are undefined
            const basePE = t3.pe * mods.pe * scenarioPEAdj;
            let finalPE = (overrides.finalPE !== undefined) ? overrides.finalPE : basePE;

            // Gordon Growth Check for final PE - REMOVED entirely for stability
            
            let rps = startRPS, pvDiv = 0, irrStream = [-startPrice], tableData = [];
            const eps0 = startRPS * (forecastMargin / 100);
            
            tableData.push({ year: 0, phase: 'Start', rps: startRPS, margin: forecastMargin, eps: eps0, flow: -startPrice, payout: startPayout, isExit: false });

            const y_p1_end = CONFIG.ANALYST_YEARS + p1_dur;
            const y_p2_end = y_p1_end + p2_dur;

            let m1 = t1.margin * mods.margin;
            let m2 = t2.margin * mods.margin;
            let m3 = t3.margin * mods.margin;
            
            if (params.themeKey !== 'Rocket') {
                m1 = Math.min(forecastMargin, m1); m2 = Math.min(forecastMargin, m2); m3 = Math.min(forecastMargin, m3);
            }
            
            // Use modified growth for interpolation
            const g1 = t1.growth * mods.growth;
            const g2 = t2.growth * mods.growth;
            const g3 = t3.growth * mods.growth;

            for (let i = 1; i <= N; i++) {
                let g, m, pay, phaseLabel = "Analyst";
                if (i <= CONFIG.ANALYST_YEARS) {
                    g = startGrowth; m = forecastMargin; pay = startPayout;
                } else {
                    let progress = 0;
                    if (i <= y_p1_end) {
                        phaseLabel = "Phase 1";
                        progress = clamp((i - CONFIG.ANALYST_YEARS - 1) / Math.max(1, p1_dur), 0, 1);
                        g = startGrowth - (startGrowth - g1) * progress;
                        m = forecastMargin - (forecastMargin - m1) * progress;
                        pay = startPayout - (startPayout - t1.payout) * progress;
                    } else if (i <= y_p2_end) {
                        phaseLabel = "Phase 2";
                        progress = clamp((i - y_p1_end - 1) / Math.max(1, p2_dur), 0, 1);
                        g = g1 - (g1 - g2) * progress;
                        m = m1 - (m1 - m2) * progress;
                        pay = t1.payout - (t1.payout - t2.payout) * progress;
                    } else {
                        phaseLabel = "Phase 3";
                        progress = clamp((i - y_p2_end - 1) / Math.max(1, p3_dur), 0, 1);
                        g = g2 - (g2 - g3) * progress;
                        m = m2 - (m2 - m3) * progress;
                        pay = t2.payout - (t2.payout - t3.payout) * progress;
                    }
                }
                pay = clamp(pay, 0, 100);
                rps = rps * (1 + g / 100);
                let eps = rps * (m / 100);
                let div = (eps > 0 ? eps : 0) * (pay / 100);
                pvDiv += div / Math.pow(1 + wacc, i);
                irrStream.push(div);
                tableData.push({ year: i, phase: phaseLabel, rps: rps, margin: m, eps: eps, flow: div, payout: pay, isExit: false });
            }

            let exitPrice = 0;
            const lastData = tableData[tableData.length - 1];
            if (lastData.eps > 0 && finalPE > 0) {
                exitPrice = lastData.eps * finalPE;
                irrStream[irrStream.length - 1] += exitPrice;
                
                // Add explicit EXIT row for the table
                tableData.push({
                    year: N,
                    phase: 'EXIT',
                    rps: null, 
                    margin: null, 
                    eps: lastData.eps, 
                    flow: exitPrice, 
                    payout: null, 
                    isExit: true,
                    finalPE: finalPE
                });
            }
            const pvExit = exitPrice / Math.pow(1 + wacc, N);
            const fv = pvDiv + pvExit;
            const irr = calculateIRR(irrStream);
            let upside = null; if (startPrice > 0 && isFinite(fv)) upside = ((fv - startPrice) / startPrice) * 100;
            let spread = null; if (irr != null) spread = (irr - wacc) * 100;

            return { tableData, irrStream, irr, wacc, fv, pvDiv, pvExit, upside, spread, finalPE, phaseTargets, themeLCX: METRICS[params.themeKey].lcX, inputs };
        }

        // --- RENDERING ---
        function renderSummary(result, inputs) {
            const { irr, wacc, fv, upside, spread, finalPE } = result;
            safeSetText('disp-years', inputs.N + ' лет');
            
            const irrEl = document.getElementById('res-irr');
            
            // REFACTORED IRR DISPLAY LOGIC
            if (irr == null) {
                irrEl.innerText = 'n/a';
                irrEl.className = "text-5xl font-bold tracking-tight text-slate-300";
            } else {
                irrEl.innerText = (irr * 100).toFixed(1) + '%';
                // Base color logic
                irrEl.className = (irr >= wacc) 
                    ? "text-5xl font-bold tracking-tight text-green-400" 
                    : "text-5xl font-bold tracking-tight text-yellow-400";
                
                // High risk warning override
                if (irr * 100 > 40 && inputs.startGrowth < 25) {
                     irrEl.className = "text-5xl font-bold tracking-tight text-orange-400"; 
                }
            }

            // Upside Color Logic
            const upEl = document.getElementById('res-upside');
            upEl.innerText = upside == null ? 'n/a' : (upside > 0 ? '+' : '') + upside.toFixed(1) + '%';
            if (upside != null && upside < 0) {
                upEl.className = "text-xl font-bold text-red-400";
            } else {
                upEl.className = "text-xl font-bold text-green-400";
            }

            safeSetText('res-fv', formatCurrency(fv));
            safeSetText('res-exit-pe', isFinite(finalPE) ? finalPE.toFixed(1) + 'x' : '--x');
        }

        function renderSensitivity(baseResult, baseInputs, theme, scenario) {
            const gridEl = document.getElementById('sens-grid');
            if (!gridEl) return;
            gridEl.innerHTML = '';
            const waccStep = 0.01, peStep = 1.0;
            const currentPE = baseResult.finalPE, currentWACC = baseResult.wacc;
            const peLabels = [
                { label: 'r \\ PE', class: 'text-slate-500' },
                { label: '-1.0x', val: currentPE - peStep },
                { label: 'Base',  val: currentPE },
                { label: '+1.0x', val: currentPE + peStep }
            ];
            peLabels.forEach((h, i) => {
                const div = document.createElement('div');
                div.className = "text-[10px] font-bold pb-1 " + (i===0 ? h.class : (i===2 ? "text-blue-600" : "text-slate-500"));
                div.innerText = h.label;
                gridEl.appendChild(div);
            });
            const waccRows = [ { label: '+1.0%', val: currentWACC + waccStep }, { label: 'Base', val: currentWACC }, { label: '-1.0%', val: currentWACC - waccStep } ];
            waccRows.forEach(row => {
                const rowHeader = document.createElement('div');
                rowHeader.className = "text-[10px] font-bold my-auto text-left pl-1 " + (row.label==='Base' ? "text-blue-600" : "text-slate-500");
                rowHeader.innerText = row.label;
                gridEl.appendChild(rowHeader);
                peLabels.slice(1).forEach(col => {
                    const simInputs = { ...baseInputs, wacc: row.val };
                    const simResult = runDCFModel(simInputs, theme, scenario, { finalPE: col.val });
                    const cell = document.createElement('div');
                    const isBase = (row.label === 'Base' && col.label === 'Base');
                    
                    // UPDATED COLORS FOR BETTER READABILITY
                    let colorClass = "bg-slate-100 text-slate-600"; // Default light gray
                    
                    if (isBase) {
                        colorClass = "bg-blue-600 text-white font-bold border border-blue-400 transform scale-105 shadow-lg z-10";
                    } else {
                        const change = (simResult.fv - baseResult.fv) / (baseResult.fv || 1);
                        if (change > 0.05) colorClass = "bg-green-100 text-green-800 font-medium border border-green-200"; // Light Green
                        else if (change < -0.05) colorClass = "bg-red-50 text-red-800 font-medium border border-red-100"; // Light Red
                    }
                    
                    cell.className = `text-[11px] font-mono py-1 rounded-sm cursor-default flex items-center justify-center ${colorClass}`;
                    cell.innerText = '$' + simResult.fv.toLocaleString('en-US', {maximumFractionDigits: 0});
                    gridEl.appendChild(cell);
                });
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                
                if (row.isExit) {
                    tr.className = "bg-indigo-100 font-bold border-t-2 border-indigo-200";
                    // Custom formatting for the requested "EPS x P/E = FLOW" style
                    // We have 7 columns: Year, Phase, RPS, Margin, EPS, Payout, Flow
                    tr.innerHTML = `
                        <td class="px-4 py-2 font-medium text-indigo-900">${row.year}</td>
                        <td class="px-4 py-2 text-xs font-bold text-indigo-700">ПРОДАЖА</td>
                        <td class="px-4 py-2 text-right text-indigo-400" colspan="2"></td>
                        <td class="px-4 py-2 text-right text-indigo-900">
                            ${formatCurrency(row.eps)} <span class="text-indigo-500">x ${row.finalPE.toFixed(1)}</span>
                        </td>
                        <td class="px-4 py-2 text-right text-indigo-400">=</td>
                        <td class="px-4 py-2 text-right font-bold text-indigo-700">${formatCurrency(row.flow)}</td>
                    `;
                } else {
                    if (row.phase === 'Analyst' || row.phase === 'Start') tr.className = "bg-amber-50 border-l-4 border-amber-300";
                    else tr.className = "hover:bg-slate-50 border-l-4 border-indigo-300";
                    
                    const usd = n => formatCurrency(n);
                    const pct = n => formatPercent(n);
                    const payoutTxt = row.year === 0 ? '-' : (row.payout != null ? row.payout.toFixed(0) + '%' : '-');

                    tr.innerHTML = `
                        <td class="px-4 py-2 font-medium text-slate-900">${row.year}</td>
                        <td class="px-4 py-2 text-xs font-bold text-slate-500">${row.phase}</td>
                        <td class="px-4 py-2 text-right text-slate-500">${row.year===0 ? '-' : usd(row.rps)}</td>
                        <td class="px-4 py-2 text-right text-slate-500">${row.year===0 ? '-' : pct(row.margin)}</td>
                        <td class="px-4 py-2 text-right text-slate-500">${row.year===0 ? '-' : usd(row.eps)}</td>
                        <td class="px-4 py-2 text-right text-purple-600 font-mono">${payoutTxt}</td>
                        <td class="px-4 py-2 text-right ${row.flow<0?'text-red-600':'text-blue-600'}">${usd(row.flow)}</td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }

        function renderLifecycleVisuals(result, themeKey, scenario) {
            // 1. Table
            const t = result.phaseTargets;
            const tbody = document.getElementById('lifecycle-table-body');
            tbody.innerHTML = `
                <tr class="border-b border-slate-50">
                    <td class="py-2 pl-2 text-slate-600">CAGR Рост</td>
                    <td class="py-2 text-right text-slate-500">${t.current.g.toFixed(1)}%</td>
                    <td class="py-2 text-right text-blue-600 font-bold bg-blue-50/50 rounded">${t.mid.g.toFixed(1)}%</td>
                    <td class="py-2 text-right text-slate-400">${t.term.g.toFixed(1)}%</td>
                </tr>
                <tr class="border-b border-slate-50">
                    <td class="py-2 pl-2 text-slate-600">Маржа</td>
                    <td class="py-2 text-right text-slate-500">${t.current.m.toFixed(1)}%</td>
                    <td class="py-2 text-right text-blue-600 font-bold bg-blue-50/50 rounded">${t.mid.m.toFixed(1)}%</td>
                    <td class="py-2 text-right text-slate-400">${t.term.m.toFixed(1)}%</td>
                </tr>
                <tr>
                    <td class="py-2 pl-2 text-slate-600">Payout</td>
                    <td class="py-2 text-right text-slate-500">${t.current.p.toFixed(0)}%</td>
                    <td class="py-2 text-right text-blue-600 font-bold bg-blue-50/50 rounded">${t.mid.p.toFixed(0)}%</td>
                    <td class="py-2 text-right text-slate-400">${t.term.p.toFixed(0)}%</td>
                </tr>
            `;

            // 2. Chart
            if (!state.charts.lc) return;
            const chart = state.charts.lc;
            
            // Calc X positions for points based on theme index logic
            // Base X comes from metric.
            const baseX = METRICS[themeKey].lcX; 
            
            const pX = Math.min(100, baseX + 15);
            const oX = Math.max(0, baseX - 15);
            
            // Determine Y values on the curve (Bell curve approx)
            const bell = (x) => 100 * Math.exp(-Math.pow(x - 40, 2) / (2 * Math.pow(25, 2))); // Peak at 40 (Growth)
            
            // Update Datasets
            // 0: Curve, 1: Pessimistic, 2: Base, 3: Optimistic
            chart.data.datasets[1].data = [{x: pX, y: bell(pX)}]; // Red
            chart.data.datasets[2].data = [{x: baseX, y: bell(baseX)}]; // Blue
            chart.data.datasets[3].data = [{x: oX, y: bell(oX)}]; // Green
            
            // Highlight current scenario
            const pointRadii = [0, 4, 4, 4]; // default small
            if(scenario === 'pessimistic') pointRadii[1] = 8;
            if(scenario === 'base') pointRadii[2] = 8;
            if(scenario === 'optimistic') pointRadii[3] = 8;
            
            chart.data.datasets[1].pointRadius = pointRadii[1];
            chart.data.datasets[2].pointRadius = pointRadii[2];
            chart.data.datasets[3].pointRadius = pointRadii[3];

            chart.update();
        }

        // --- CHARTS ---
        function initChart() {
            // Cash Flow Chart
            const ctx = document.getElementById('cfChart');
            if (ctx) {
                state.charts.cf = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { display:false }, x: { display: false } }
                    }
                });
            }

            // Lifecycle Chart
            const ctxLc = document.getElementById('lifecycleChart');
            if (ctxLc) {
                // Generate curve points
                const curveData = [];
                for(let i=0; i<=100; i+=2) {
                    // S-Curve derivative (Bell-ish): Start low, peak at expansion, steady, decline
                    // Using Gaussian for simplicity centered at 40
                    const y = 100 * Math.exp(-Math.pow(i - 40, 2) / (2 * Math.pow(25, 2)));
                    curveData.push({x: i, y: y});
                }

                state.charts.lc = new Chart(ctxLc.getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Lifecycle',
                                data: curveData,
                                borderColor: '#cbd5e1',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true,
                                backgroundColor: 'rgba(241, 245, 249, 0.5)',
                                tension: 0.4
                            },
                            { label: 'Pessimistic', data: [], backgroundColor: '#ef4444', pointRadius: 5, type: 'scatter' }, // Red
                            { label: 'Base',        data: [], backgroundColor: '#3b82f6', pointRadius: 6, type: 'scatter' }, // Blue
                            { label: 'Optimistic',  data: [], backgroundColor: '#22c55e', pointRadius: 5, type: 'scatter' }  // Green
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        scales: {
                            x: { type: 'linear', display: true, min: 0, max: 100, title: {display: true, text: 'Стадии: Старт -> Рост -> Зрелость -> Спад'} },
                            y: { display: false, min: 0, max: 110 }
                        }
                    }
                });
            }
        }

        function updateChart(stream) {
            if (!state.charts.cf) return;
            const labels = stream.map((_, i) => i === 0 ? 'Start' : `Y${i}`);
            const colors = stream.map((v, i) => {
                if (i === 0) return '#ef4444';
                if (i === stream.length - 1) return '#4f46e5'; 
                if (i <= 2) return '#f59e0b'; 
                return '#3b82f6';
            });
            
            // Linear scale only as log doesn't work with negative start values
            state.charts.cf.options.scales.y = { type: 'linear', display: true };
            state.charts.cf.data.labels = labels;
            state.charts.cf.data.datasets = [{ label: 'Flow', data: stream, backgroundColor: colors }];
            state.charts.cf.update();
        }

        // --- MAIN ---
        function readInputsFromDOM() {
            const getVal = (id) => parseFloat(document.getElementById(id).value);
            const waccInput = getVal('inp-wacc'); // Capture separate variable
            return {
                startPrice: getVal('inp-price') || 0,
                startRPS: getVal('inp-rps') || 0,
                startGrowth: getVal('inp-growth') || 0,
                forecastMargin: getVal('inp-forecast-margin') || 0,
                // Check isNaN so 0 is allowed
                wacc: (isNaN(waccInput) ? 8 : waccInput)/100,
                startPayout: getVal('inp-payout') || 0,
                N: parseInt(document.getElementById('slider-years').value) || 15
            };
        }

        function calculate() {
            const userTheme = document.getElementById('theme-selector').value;
            const inputs = readInputsFromDOM();
            
            // 1. Run Base to populate basic data
            const result = runDCFModel(inputs, userTheme, state.scenario);
            renderSummary(result, inputs);
            renderTable(result.tableData);
            updateChart(result.irrStream);
            renderSensitivity(result, inputs, userTheme, state.scenario);
            
            // 2. Lifecycle Visuals
            renderLifecycleVisuals(result, userTheme, state.scenario);
        }

        function setScenario(s) {
            const themeKey = document.getElementById('theme-selector').value;
            state.scenario = s;
            ['pessimistic', 'base', 'optimistic'].forEach(id => {
                const btn = document.getElementById('btn-' + id);
                if (!btn) return;
                const isAct = (id === s);
                if (id === 'pessimistic') btn.className = isAct ? "flex-1 py-3 text-xs bg-red-100 text-red-800 border-red-300 rounded-lg shadow-inner font-bold border" : "flex-1 py-3 text-xs border rounded-lg hover:bg-slate-50 transition-all font-medium text-slate-600";
                else if (id === 'optimistic') btn.className = isAct ? "flex-1 py-3 text-xs bg-green-100 text-green-800 border-green-300 rounded-lg shadow-inner font-bold border" : "flex-1 py-3 text-xs border rounded-lg hover:bg-slate-50 transition-all font-medium text-slate-600";
                else btn.className = isAct ? "flex-1 py-3 text-xs bg-blue-600 text-white rounded-lg shadow-md font-bold" : "flex-1 py-3 text-xs border rounded-lg hover:bg-slate-50 transition-all font-medium text-slate-600";
            });
            const params = getCalcParams(themeKey, s);
            const slider = document.getElementById('slider-years');
            // Adjust slider N based on scenario only if user hasn't manually set it
            if (slider && !state.userSetYears) {
                const baseN = METRICS[params.themeKey].N || 12;
                slider.value = getScenarioHorizon(baseN, s);
            }
            calculate();
        }

        // --- INIT ---
        window.addEventListener('load', () => {
            initChart();
            setScenario('base');
        });

        // Listeners
        document.getElementById('inp-ticker').addEventListener('keypress', (e) => { if(e.key==='Enter') loadTicker(); });
        document.getElementById('theme-selector').addEventListener('change', () => setScenario(state.scenario || 'base'));
        document.getElementById('slider-years').addEventListener('input', () => { state.userSetYears = true; calculate(); });
        ['inp-price', 'inp-rps', 'inp-growth', 'inp-forecast-margin', 'inp-wacc', 'inp-payout'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculate);
        });
    </script>
</body>
</html>
