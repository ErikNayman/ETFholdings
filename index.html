<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCF Pro: Lifecycle & Targets</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; }
        input[type=range]:focus { outline: none; }
        .chart-container { position: relative; width: 100%; height: 280px; }
        .lc-chart-container { position: relative; width: 100%; height: 220px; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        
        /* Timeline styling */
        .timeline-line { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: #e2e8f0; z-index: 0; transform: translateY(-50%); }
        .timeline-segment { flex: 1; text-align: center; position: relative; padding-top: 20px; }
        .timeline-dot { width: 12px; height: 12px; border-radius: 50%; background: white; border: 2px solid #64748b; margin: 0 auto; position: relative; z-index: 10; }
        .timeline-segment.active .timeline-dot { border-color: #3b82f6; background: #eff6ff; }
        
        .dur-badge { 
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%); 
            font-size: 0.65rem; background: #f1f5f9; padding: 1px 6px; border-radius: 99px; 
            border: 1px solid #cbd5e1; color: #64748b; font-weight: 600; z-index: 5;
        }

        @keyframes flash {
            0% { background-color: #dbeafe; }
            100% { background-color: white; }
        }
        .flash-update {
            animation: flash 1s ease-out;
        }
    </style>
</head>
<body class="antialiased">

    <div class="max-w-7xl mx-auto px-4 py-6">

        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">DCF Pro: Lifecycle Engine</h1>
                <p class="text-sm text-slate-500">
                    Оценка стоимости P/S Anchor & Lifecycle.
                </p>
            </div>
            <div class="text-right">
                <div class="text-xs text-slate-400 uppercase">Метрика</div>
                <div class="text-sm font-bold text-indigo-600">IRR vs Cost of Capital (r)</div>
            </div>
        </header>

        <div class="grid lg:grid-cols-12 gap-6">

            <!-- LEFT COLUMN: CONTROLS -->
            <div class="lg:col-span-4 space-y-5">
                
                <!-- DATA SOURCE PANEL -->
                <div class="bg-indigo-600 rounded-xl shadow-lg p-4 text-white">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-indigo-200 uppercase tracking-wider">Источник данных</label>
                        <span id="db-status" class="text-[10px] bg-indigo-500 px-2 py-0.5 rounded text-indigo-100">Демо База</span>
                    </div>

                    <!-- Excel Upload -->
                    <div class="mb-4 relative group">
                        <label for="excel-upload" class="flex items-center justify-center w-full px-4 py-2 bg-indigo-500 hover:bg-indigo-400 border border-indigo-400 border-dashed rounded cursor-pointer transition-colors text-xs font-bold uppercase select-none">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            Загрузить Excel (.xlsx)
                        </label>
                        <input id="excel-upload" type="file" accept=".xlsx, .xls" class="hidden" onchange="handleExcelUpload(event)">
                        <div class="hidden group-hover:block absolute top-full left-0 w-full bg-slate-800 text-slate-200 text-[10px] p-3 rounded mt-1 z-20 shadow-xl border border-slate-600 leading-relaxed">
                            <strong>Нужные колонки:</strong><br>
                            Ticker, Price, RPS, Growth, Margin, WACC, Payout<br>
                            <em class="text-slate-400">Опционально: Theme, N, PE, PS</em>
                        </div>
                    </div>
                    <div id="upload-error" class="text-xs bg-red-500 text-white p-2 rounded mb-2 hidden"></div>

                    <!-- Search -->
                    <div class="flex gap-2">
                        <input type="text" id="inp-ticker" placeholder="TICKER (e.g. SPY, QQQ)" class="w-full bg-indigo-700 border border-indigo-500 text-white placeholder-indigo-300 rounded px-3 py-2 font-bold uppercase focus:outline-none focus:ring-2 focus:ring-white">
                        <button onclick="loadTicker()" class="bg-white text-indigo-600 px-4 py-2 rounded font-bold hover:bg-indigo-50 transition-colors">Go</button>
                    </div>
                    <div id="ticker-error" class="text-xs text-red-300 mt-2 hidden">Тикер не найден</div>
                </div>

                <!-- INPUTS -->
                <div id="inputs-panel" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 border-l-4 border-l-slate-400 transition-colors duration-500">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-700 uppercase">1. Параметры Входа</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="resetToDefaults()" id="btn-reset" class="text-[10px] font-bold text-indigo-600 hover:text-indigo-800 uppercase bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100 transition-colors hidden" title="Вернуть исходные значения">
                                ↺ Сброс
                            </button>
                            <span id="company-name" class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded">Custom</span>
                        </div>
                    </div>
                    
                    <label class="block text-[10px] font-bold text-slate-400 mb-1">ПРОФИЛЬ БИЗНЕСА (АВТО)</label>
                    <select id="theme-selector" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-slate-50 font-medium mb-3">
                        <option value="Rocket">Rocket Growth (Startups)</option>
                        <option value="Expansion">Expansion Compounder (NVDA)</option>
                        <option value="IndexTech">Index Tech / Growth (QQQ)</option>
                        <option value="Momentum">Quality Momentum (AAPL)</option>
                        <option value="Steady">Steady Compounder (SPY)</option>
                        <option value="IndexValue">Index Value / Blue Chip (DIA)</option>
                        <option value="Dividend">Dividend Stability (JPM)</option>
                        <option value="Fallen">Fallen Angel (PYPL)</option>
                        <option value="DeepValue">Deep Value (GM)</option>
                    </select>

                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="col-span-2">
                            <div class="flex justify-between items-center">
                                <label class="block text-xs font-bold text-slate-700">Цена Акции ($)</label>
                                <div class="flex gap-2">
                                    <span id="disp-current-pe" class="text-[9px] text-slate-400 bg-slate-100 px-1 rounded" title="Текущий P/E">PE: --</span>
                                    <span id="disp-current-ps" class="text-[9px] text-slate-400 bg-slate-100 px-1 rounded" title="Текущий P/S">PS: --</span>
                                </div>
                            </div>
                            <input type="number" id="inp-price" class="w-full border-2 border-blue-100 p-2 rounded font-bold text-blue-800 text-lg" value="150">
                        </div>

                        <div>
                            <label class="block text-xs text-slate-400">RPS ($)</label>
                            <input type="number" id="inp-rps" class="w-full border p-1 rounded" value="20">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400">Рост (%)</label>
                            <input type="number" id="inp-growth" class="w-full border p-1 rounded font-bold text-green-600" value="10">
                        </div>
                        
                        <div class="col-span-2 bg-yellow-50 p-2 rounded border border-yellow-100">
                            <label class="block text-xs font-bold text-yellow-800">Прогноз Маржи (2025-27)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="inp-forecast-margin" class="w-full bg-white border p-1 rounded font-bold text-slate-700" value="15.0">
                                <span class="text-xs text-slate-500">%</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs text-slate-400">Стоимость капитала (r, %)</label>
                            <input type="number" id="inp-wacc" class="w-full border p-1 rounded" value="8" step="0.1" min="0">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 font-bold text-purple-600">Нач. Payout (%)</label>
                            <input type="number" id="inp-payout" class="w-full border-2 border-purple-100 p-1 rounded font-bold text-purple-700" value="30">
                        </div>
                    </div>
                </div>

                <!-- SCENARIO & RESULTS -->
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-4 ring-1 ring-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 uppercase mb-3">2. Сценарный Двигатель</h3>
                    <div class="flex space-x-2 mb-6">
                        <button onclick="setScenario('pessimistic')" id="btn-pessimistic" class="flex-1 py-3 text-xs border rounded-lg hover:bg-red-50 transition-all font-medium text-slate-600">Пессимизм</button>
                        <button onclick="setScenario('base')" id="btn-base" class="flex-1 py-3 text-xs bg-blue-600 text-white rounded-lg shadow-md transition-all font-bold">Базовый</button>
                        <button onclick="setScenario('optimistic')" id="btn-optimistic" class="flex-1 py-3 text-xs border rounded-lg hover:bg-green-50 transition-all font-medium text-slate-600">Оптимизм</button>
                    </div>
                    
                    <div class="mt-6 mb-2">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-bold text-slate-500">Общий горизонт (N)</label>
                            <span id="disp-years" class="text-xs font-bold text-blue-600">-- лет</span>
                        </div>
                        <input type="range" id="slider-years" min="5" max="35" step="1" class="w-full h-1.5 bg-slate-200 rounded-lg accent-blue-600">
                    </div>
                </div>

                <div class="bg-slate-800 rounded-xl p-5 text-white shadow-xl">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest">IRR (Прогноз)</h4>
                            <div class="text-5xl font-bold tracking-tight" id="res-irr">--%</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-slate-400 uppercase">Upside</div>
                            <div id="res-upside" class="text-xl font-bold text-green-400">--%</div>
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-2 border-t border-slate-600 text-[10px] text-slate-400 flex justify-between">
                        <span>Fair Value: <span id="res-fv" class="text-white font-bold">$---</span></span>
                        <div class="text-right">
                            <div class="text-[9px] text-slate-500">EXIT MULTIPLES</div>
                            <div>
                                <span class="text-slate-400 mr-1">P/E:</span><span id="res-exit-pe" class="text-white font-bold mr-2">--x</span>
                                <span class="text-slate-400 mr-1">P/S:</span><span id="res-exit-ps" class="text-white font-bold">--x</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: VISUALS -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- LIFECYCLE CHART & METRICS -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <h3 class="text-sm font-bold text-slate-700 mb-4">Жизненный Цикл и Целевые Показатели</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Chart -->
                        <div>
                            <div class="lc-chart-container">
                                <canvas id="lifecycleChart"></canvas>
                            </div>
                            <div class="text-center text-[10px] text-slate-400 mt-2 italic">
                                Карта рынка: Точки тем (серые), ETF (квадраты) и Ваша Компания (круг)
                            </div>
                        </div>

                        <!-- Targets Table -->
                        <div class="flex flex-col justify-center">
                            <table class="w-full text-sm text-left border-collapse">
                                <thead>
                                    <tr class="text-[10px] uppercase text-slate-400 border-b border-slate-100">
                                        <th class="py-2 pl-2">Показатель</th>
                                        <th class="py-2 text-right">Текущий</th>
                                        <th class="py-2 text-right text-blue-600 font-bold">Цель (Mid)</th>
                                        <th class="py-2 text-right text-slate-500">Терминал</th>
                                    </tr>
                                </thead>
                                <tbody id="lifecycle-table-body" class="text-xs font-medium divide-y divide-slate-50">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                            <div class="mt-3 text-[10px] text-slate-400 bg-slate-50 p-2 rounded">
                                <strong>Как читать:</strong> Модель плавно интерполирует значения от "Текущих" к "Целевым" (фаза роста) и затем к "Терминальным" (зрелость).
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SENSITIVITY MATRIX -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <div class="flex justify-between items-end mb-2">
                        <h4 class="text-xs font-bold text-slate-700 uppercase tracking-widest">Матрица Справедливой Цены (PV Today)</h4>
                        <span class="text-[10px] text-slate-500">Влияние ставки (r) и мультипликатора (P/E)</span>
                    </div>
                    <div class="grid grid-cols-4 gap-1 text-center select-none" id="sens-grid">
                        <!-- JS Generated -->
                    </div>
                </div>

                <!-- CALCULATION DETAILS TABLE -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200 bg-slate-50 flex justify-between">
                        <h3 class="text-sm font-bold text-slate-700">Детализация Расчета</h3>
                        <span class="text-xs text-slate-400">Номинальные значения ($)</span>
                    </div>
                    <div class="overflow-x-auto custom-scroll" style="max-height: 350px;">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 uppercase bg-white sticky top-0 border-b">
                                <tr>
                                    <th class="px-4 py-2">Год</th>
                                    <th class="px-4 py-2">Фаза</th>
                                    <th class="px-4 py-2 text-right">RPS</th>
                                    <th class="px-4 py-2 text-right">Маржа</th>
                                    <th class="px-4 py-2 text-right">EPS</th>
                                    <th class="px-4 py-2 text-right text-purple-600">Payout</th>
                                    <th class="px-4 py-2 text-right font-bold text-blue-600">Flow</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TAIL_PENALTY = {
            START_YEAR: 15,   
            EXTRA_DR: 0.01    
        };

        const CONFIG = {
            ANALYST_YEARS: 2,
            DEFAULT_WACC: 0.08,
            IRR_MAX_ITER: 1000,
            IRR_TOL: 1e-6,
            IRR_MIN_RATE: -0.99,
            IRR_MAX_RATE: 5
        };

        const THEME_ORDER = ['Rocket', 'Expansion', 'IndexTech', 'Momentum', 'Steady', 'IndexValue', 'Dividend', 'DeepValue', 'Fallen'];
        
        // --- DEMO DATABASE ---
        const DEMO_DB = {
            'SPY': { name: 'S&P 500 ETF', price: 683.39, rps: 200.7, growth: 8.2, margin: 14.9, wacc: 8.0, payout: 27.1, profile: 'Steady', ps: 3.40, pe: 22.8 }, 
            'QQQ': { name: 'Invesco QQQ (Nasdaq)', price: 445.0, rps: 130.5, growth: 11.0, margin: 19.5, wacc: 8.5, payout: 10, profile: 'IndexTech', ps: 6.2, pe: 31.5 }, 
            'DIA': { name: 'SPDR Dow Jones', price: 395.0, rps: 280.0, growth: 6.5, margin: 12.5, wacc: 7.5, payout: 35, profile: 'IndexValue', ps: 2.8, pe: 22.0 }, 
            'AAPL': { name: 'Apple Inc.', price: 189.5, rps: 24.5, growth: 6.5, margin: 26.5, wacc: 8.5, payout: 15, ps: 7.7, pe: 29.0 },
            'NVDA': { name: 'Nvidia Corp', price: 880.0, rps: 24.8, growth: 65.0, margin: 55.0, wacc: 9.0, payout: 2, ps: 35.0, pe: 65.0 },
            'TSLA': { name: 'Tesla Inc', price: 175.2, rps: 30.1, growth: 15.0, margin: 10.5, wacc: 10.5, payout: 0, ps: 5.8, pe: 55.0 },
            'MSFT': { name: 'Microsoft', price: 420.0, rps: 31.5, growth: 12.0, margin: 36.0, wacc: 8.0, payout: 25, ps: 13.0, pe: 36.0 },
            'AMZN': { name: 'Amazon', price: 178.0, rps: 55.0, growth: 11.0, margin: 6.5, wacc: 9.0, payout: 0, ps: 3.2, pe: 45.0 },
            'GOOGL': { name: 'Alphabet', price: 173.0, rps: 24.0, growth: 10.0, margin: 24.0, wacc: 8.5, payout: 10, ps: 6.5, pe: 24.0 }
        };

        // Current Active DB
        let GLOBAL_DB = { ...DEMO_DB };

        // METRICS with P/S field added
        const METRICS = {
            'Rocket':    { name: 'Rocket',    growth: 40,    margin: 3.8,   pe: 407.9, ps: 15.39, payout: 0,  N: 20, lcX: 15 }, 
            'Expansion': { name: 'Expansion', growth: 20.0, margin: 33.9,  pe: 24.0,  ps: 8.13,  payout: 15, N: 15, lcX: 30 }, 
            'IndexTech': { name: 'Index Tech',growth: 11.0, margin: 24.0,  pe: 26.0,  ps: 6.20,  payout: 15, N: 15, lcX: 40 }, 
            'Momentum':  { name: 'Momentum',  growth: 14.3, margin: 26.0,  pe: 22.1,  ps: 5.73,  payout: 50, N: 12, lcX: 55 }, 
            'Steady':    { name: 'Steady',    growth: 7.9,  margin: 14.0,  pe: 22.0,  ps: 3.10,  payout: 45, N: 12, lcX: 65 }, 
            'IndexValue':{ name: 'Index Value',growth: 6.5, margin: 12.5,  pe: 19.5,  ps: 2.45,  payout: 40, N: 12, lcX: 75 }, 
            'Dividend':  { name: 'Dividend',  growth: 6.0,  margin: 14.8,  pe: 13.5,  ps: 2.00,  payout: 75, N: 9,  lcX: 85 },
            'DeepValue': { name: 'Value',     growth: 2.7,  margin: 12.1,  pe: 11.7,  ps: 1.42,  payout: 50, N: 6,  lcX: 95 },
            'Fallen':    { name: 'Fallen',    growth: 22.4, margin: 7.5,   pe: 14.0,  ps: 1.05,  payout: 30, N: 9,  lcX: 90 } 
        };

        // ... (Chains remain same)
        const BASE_CHAINS = {
            'Rocket':    ['Rocket', 'Expansion', 'Momentum'],
            'Expansion': ['Expansion', 'Momentum', 'Steady'],
            'IndexTech': ['IndexTech', 'Momentum', 'Steady'],
            'Momentum':  ['Momentum', 'Steady', 'Dividend'],
            'Steady':    ['Steady', 'Dividend', 'DeepValue'],
            'IndexValue':['IndexValue', 'Dividend', 'DeepValue'],
            'Dividend':  ['Dividend', 'DeepValue', 'DeepValue'],
            'Fallen':    ['Fallen', 'DeepValue', 'Steady'],
            'DeepValue': ['DeepValue', 'Steady', 'Dividend']
        };

        const EDGE_MODS = {
            rocket_opt: { pe: 1.25, margin: 1.2, growth: 1.1 },
            deep_pess:  { pe: 0.8,  margin: 0.8, growth: 0.8 }
        };

        let state = { 
            scenario: 'base', 
            charts: {}, 
            userSetYears: false, 
            currentTicker: '',
            maxNFromFile: null 
        };
        
        // Bell Curve for charts
        const bellCurve = (x) => 100 * Math.exp(-Math.pow(x - 40, 2) / (2 * Math.pow(25, 2)));

        // --- EXCEL LOGIC ---
        function handleExcelUpload(e) {
            const errEl = document.getElementById('upload-error');
            errEl.classList.add('hidden');
            
            if (typeof XLSX === 'undefined') {
                errEl.innerText = "Ошибка: Библиотека Excel не загрузилась.";
                errEl.classList.remove('hidden');
                return;
            }

            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    let successCount = 0;
                    for (const sheetName of workbook.SheetNames) {
                        const worksheet = workbook.Sheets[sheetName];
                        const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        const res = extractDataFromSheet(rawData);
                        if (res && res.count > 0) {
                            GLOBAL_DB = { ...GLOBAL_DB, ...res.db };
                            successCount += res.count;
                        }
                    }
                    if (successCount > 0) {
                        document.getElementById('db-status').innerText = `Excel (${successCount} шт.)`;
                        document.getElementById('db-status').className = "text-[10px] bg-green-500 px-2 py-0.5 rounded text-white";
                        alert(`Успешно загружено ${successCount} компаний! Введите тикер в поиск.`);
                    } else {
                        errEl.innerText = "Не удалось найти данные. Проверьте заголовки (Ticker, Price...).";
                        errEl.classList.remove('hidden');
                    }
                } catch (err) {
                    console.error(err);
                    errEl.innerText = "Ошибка чтения файла.";
                    errEl.classList.remove('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function normalizeTheme(raw) {
            if (!raw) return null;
            const str = String(raw).toLowerCase().trim();
            const keys = Object.keys(METRICS);
            const exact = keys.find(k => k.toLowerCase() === str);
            if (exact) return exact;
            
            if (str.includes('nasdaq') || str.includes('qqq') || str.includes('tech index')) return 'IndexTech';
            if (str.includes('dow') || str.includes('dia') || str.includes('value index')) return 'IndexValue';
            if (str.includes('rocket') || str.includes('start')) return 'Rocket';
            if (str.includes('expansion') || str.includes('nvda')) return 'Expansion';
            if (str.includes('momentum') || str.includes('quality')) return 'Momentum';
            if (str.includes('steady') || str.includes('compounder')) return 'Steady';
            if (str.includes('dividend') || str.includes('yield')) return 'Dividend';
            if (str.includes('deep') || str.includes('value')) return 'DeepValue';
            if (str.includes('fallen')) return 'Fallen';
            return null;
        }

        function extractDataFromSheet(rows) {
            const newDB = {};
            let count = 0;
            if (!rows || rows.length === 0) return { count: 0, db: {} };

            let headerRowIndex = -1;
            let colMap = {}; 
            
            // STRICT MATCHING LOGIC
            const keyMap = {
                ticker: ['ticker', 'symbol', 'code', 'тикер'],
                price: ['price', 'close', 'last', 'цена'],
                rps: ['rps', 'revenue', 'sales', 'выручка'], 
                growth: ['growth', 'cagr', 'рост'], 
                margin: ['margin', 'net margin', 'margin %', 'маржа'],
                wacc: ['wacc', 'cost of capital', 'ставка', 'ks'], 
                payout: ['payout', 'dividen', 'дивиден'], 
                theme: ['theme', 'profile', 'strategy', 'тема'],
                n: ['n term', 'n_term', 'years', 'term', 'srok', 'срок', 'horizon', 'n term'],
                pe: ['pe', 'p/e', 'forward pe', 'pe_curr', 'p/e ratio'],
                ps: ['ps', 'p/s', 'forward ps', 'ps_curr', 'p/s ratio']
            };

            for (let i = 0; i < Math.min(rows.length, 20); i++) {
                const row = rows[i];
                let tempMap = {};
                row.forEach((cell, cellIdx) => {
                    if (!cell) return;
                    const val = String(cell).toLowerCase().replace('.', '').trim();
                    
                    for (const [key, candidates] of Object.entries(keyMap)) {
                        const isMatch = candidates.some(c => {
                            if (c.length <= 4 && !c.includes('/')) return val === c; 
                            return val.includes(c);
                        });
                        if (isMatch && tempMap[key] === undefined) tempMap[key] = cellIdx;
                    }
                });
                if (tempMap.ticker !== undefined && tempMap.price !== undefined) {
                    headerRowIndex = i; colMap = tempMap; break;
                }
            }

            if (headerRowIndex === -1) return { count: 0, db: {} };

            for (let i = headerRowIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                const getValue = (key) => {
                    const idx = colMap[key];
                    return idx !== undefined ? row[idx] : null;
                };
                const rawTicker = getValue('ticker');
                const rawPrice = getValue('price');

                if (rawTicker && rawPrice) {
                    const ticker = String(rawTicker).trim().toUpperCase();
                    const safeFloat = (val, def) => {
                        const parsed = parseFloat(val);
                        return isNaN(parsed) ? def : parsed;
                    };
                    const nVal = safeFloat(getValue('n'), null);
                    
                    newDB[ticker] = {
                        name: ticker + ' (Excel)',
                        price: safeFloat(rawPrice, 0),
                        rps: safeFloat(getValue('rps'), 10),
                        growth: safeFloat(getValue('growth'), 5),
                        margin: safeFloat(getValue('margin'), 10),
                        wacc: safeFloat(getValue('wacc'), 8), 
                        payout: safeFloat(getValue('payout'), 0),
                        profile: normalizeTheme(getValue('theme')),
                        n_term: nVal,
                        pe: safeFloat(getValue('pe'), null),
                        ps: safeFloat(getValue('ps'), null)
                    };
                    count++;
                }
            }
            return { count, db: newDB };
        }

        // --- AUTO-PROFILE ---
        function detectProfile(data) {
            const g = data.growth;
            const m = data.margin;
            const p = data.payout;
            if (data.name && data.name.includes('Nasdaq')) return 'IndexTech';
            if (data.name && data.name.includes('Dow')) return 'IndexValue';
            
            if (g > 30) return 'Rocket';
            if (g > 15 && m > 20) return 'Expansion';
            if (g > 10 && m > 15 && p > 10) return 'Momentum';
            if (p > 60) return 'Dividend';
            if (g < 5 && p > 0) return 'DeepValue';
            if (g > 15 && m < 10) return 'Fallen';
            return 'Steady'; 
        }

        // --- SCENARIO HELPER ---
        function getTerminalParams(baseTheme, scenario, ticker) {
            if (['SPY', 'QQQ', 'DIA'].includes(ticker)) {
                let adj = 1.0;
                if (scenario === 'optimistic') adj = 1.05;
                if (scenario === 'pessimistic') adj = 0.95;
                return { themeKey: baseTheme, adj: adj };
            }

            const themeIndex = THEME_ORDER.indexOf(baseTheme);
            let targetThemeKey = baseTheme;
            let scenarioAdj = 1.0;

            if (scenario === 'base') {
                return { themeKey: baseTheme, adj: 1.0 };
            }

            if (scenario === 'pessimistic') {
                if (baseTheme === 'Fallen' || baseTheme === 'DeepValue') {
                    return { themeKey: baseTheme, adj: 0.9 }; 
                }
                if (themeIndex !== -1 && themeIndex < THEME_ORDER.length - 1) {
                    targetThemeKey = THEME_ORDER[themeIndex + 1];
                }
                return { themeKey: targetThemeKey, adj: 1.0 };
            }

            if (scenario === 'optimistic') {
                if (baseTheme === 'Rocket') {
                    // Prevent Expansion -> Rocket shift in optimistic.
                    // If user selected 'Expansion', they should not become 'Rocket'
                    // This logic only applies if baseTheme was Rocket initially.
                    return { themeKey: 'Rocket', adj: 1.15 }; 
                }
                // --- NEW FIX: Prevent Expansion -> Rocket shift explicitly ---
                if (baseTheme === 'Expansion') {
                     // Stay Expansion, but with premium adj. Do NOT shift left to Rocket.
                     return { themeKey: 'Expansion', adj: 1.15 };
                }

                if (baseTheme === 'Fallen') {
                    return { themeKey: 'Steady', adj: 1.0 }; 
                }
                if (themeIndex > 0) {
                    targetThemeKey = THEME_ORDER[themeIndex - 1];
                }
                return { themeKey: targetThemeKey, adj: 1.0 };
            }
            
            return { themeKey: baseTheme, adj: 1.0 };
        }

        function loadTicker() {
            const inputEl = document.getElementById('inp-ticker');
            const errorEl = document.getElementById('ticker-error');
            const panelEl = document.getElementById('inputs-panel');
            const rawTicker = inputEl.value.trim().toUpperCase();

            errorEl.classList.add('hidden');
            
            if (GLOBAL_DB[rawTicker]) {
                const data = GLOBAL_DB[rawTicker];
                state.currentTicker = rawTicker; 
                
                document.getElementById('inp-price').value = data.price ? Number(data.price).toFixed(2) : '';
                document.getElementById('inp-rps').value = data.rps ? Number(data.rps).toFixed(2) : '';
                document.getElementById('inp-growth').value = data.growth ? Number(data.growth).toFixed(2) : '';
                document.getElementById('inp-forecast-margin').value = data.margin ? Number(data.margin).toFixed(2) : '';
                document.getElementById('inp-wacc').value = data.wacc ? Number(data.wacc).toFixed(2) : '';
                document.getElementById('inp-payout').value = data.payout ? Number(data.payout).toFixed(2) : '';
                
                const peBadge = document.getElementById('disp-current-pe');
                const psBadge = document.getElementById('disp-current-ps');
                
                const calcPE = (data.price / (data.rps * data.margin/100)).toFixed(1);
                const calcPS = (data.price / data.rps).toFixed(2);
                
                peBadge.innerText = data.pe ? `PE: ${data.pe.toFixed(1)}x` : `PE: ${calcPE}x*`;
                psBadge.innerText = data.ps ? `PS: ${data.ps.toFixed(2)}x` : `PS: ${calcPS}x*`;
                
                peBadge.className = data.pe ? "text-[9px] font-bold text-blue-600 bg-blue-50 px-1 rounded" : "text-[9px] text-slate-400 bg-slate-100 px-1 rounded";
                psBadge.className = data.ps ? "text-[9px] font-bold text-blue-600 bg-blue-50 px-1 rounded" : "text-[9px] text-slate-400 bg-slate-100 px-1 rounded";

                const profile = data.profile || detectProfile(data);
                document.getElementById('theme-selector').value = profile;
                safeSetText('company-name', data.name || rawTicker);

                const slider = document.getElementById('slider-years');
                if (data.n_term && data.n_term > 0) {
                    const nTerm = Math.min(Math.max(data.n_term, 5), 35); 
                    slider.max = nTerm;
                    slider.value = nTerm;
                    state.userSetYears = true;
                    state.maxNFromFile = nTerm;
                } else {
                    slider.max = 35; 
                    state.userSetYears = false; 
                    state.maxNFromFile = null;
                }

                panelEl.classList.add('flash-update');
                setTimeout(() => panelEl.classList.remove('flash-update'), 1000);
                state.scenario = 'base'; 
                setScenario('base'); 
                document.getElementById('btn-reset').classList.remove('hidden');
            } else {
                errorEl.classList.remove('hidden');
                errorEl.innerText = `Тикер "${rawTicker}" не найден.`;
                document.getElementById('btn-reset').classList.add('hidden');
            }
        }
        
        function resetToDefaults() {
            if (!state.currentTicker || !GLOBAL_DB[state.currentTicker]) return;
            const data = GLOBAL_DB[state.currentTicker];
            
            document.getElementById('inp-price').value = data.price ? Number(data.price).toFixed(2) : '';
            document.getElementById('inp-rps').value = data.rps ? Number(data.rps).toFixed(2) : '';
            document.getElementById('inp-growth').value = data.growth ? Number(data.growth).toFixed(2) : '';
            document.getElementById('inp-forecast-margin').value = data.margin ? Number(data.margin).toFixed(2) : '';
            document.getElementById('inp-wacc').value = data.wacc ? Number(data.wacc).toFixed(2) : '';
            document.getElementById('inp-payout').value = data.payout ? Number(data.payout).toFixed(2) : '';
            
            const profile = data.profile || detectProfile(data);
            document.getElementById('theme-selector').value = profile;
            
            const slider = document.getElementById('slider-years');
            if (data.n_term && data.n_term > 0) {
                const nTerm = Math.min(Math.max(data.n_term, 5), 35);
                slider.max = nTerm;
                slider.value = nTerm;
                state.userSetYears = true;
                state.maxNFromFile = nTerm;
            } else {
                slider.max = 35;
                state.userSetYears = false; 
                state.maxNFromFile = null;
            }
            
            const panel = document.getElementById('inputs-panel');
            panel.classList.remove('flash-update');
            void panel.offsetWidth; 
            panel.classList.add('flash-update');
            
            state.scenario = 'base';
            setScenario('base');
        }

        // --- HELPERS ---
        function safeSetText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }
        function formatCurrency(n) { return n == null || !isFinite(n) ? '$---' : n.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }); }
        function formatPercent(n) { return n == null || !isFinite(n) ? '--%' : n.toFixed(1) + '%'; }
        function clamp(v, min, max) { return Math.min(max, Math.max(min, v)); }

        // --- SCENARIO HORIZON HELPER ---
        function getScenarioHorizon(baseN, scenario) {
            const minN = 5;
            let maxN = 30; 

            if (state.maxNFromFile != null) {
                maxN = Math.min(maxN, state.maxNFromFile);
            }

            if (scenario === 'optimistic') {
                return clamp(Math.round(baseN * 1.2), minN, maxN);
            }
            if (scenario === 'pessimistic') {
                return clamp(Math.round(baseN * 0.8), minN, maxN);
            }
            return clamp(baseN, minN, maxN);
        }

        // --- CALC PARAMS ---
        function getCalcParams(selected, scenario, ticker) {
            let res = { themeKey: selected, mods: { pe: 1, margin: 1, growth: 1 }, chain: BASE_CHAINS[selected] || ['Steady', 'Steady', 'Steady'] };
            
            // --- INDEX EXCEPTIONS ---
            if (['SPY', 'QQQ', 'DIA'].includes(ticker)) {
                if (ticker === 'QQQ') res.chain = ['IndexTech', 'IndexTech', 'Steady'];
                else if (ticker === 'DIA') res.chain = ['IndexValue', 'IndexValue', 'IndexValue'];
                else res.chain = ['Steady', 'Steady', 'Steady'];
                
                if (scenario === 'optimistic') res.mods = { pe: 1.15, margin: 1.05, growth: 1.1 }; 
                else if (scenario === 'pessimistic') res.mods = { pe: 0.9, margin: 0.95, growth: 0.9 };
                return res;
            }

            // --- EXPANSION EXCEPTION ---
            if (selected === 'Expansion') {
                if (scenario === 'optimistic') {
                    res.chain = ['Expansion', 'Expansion', 'Momentum']; 
                    res.mods = { pe: 1.2, margin: 1.05, growth: 1.15 };
                } else if (scenario === 'pessimistic') {
                    res.mods = { pe: 0.9, margin: 0.95, growth: 0.85 };
                } 
                return res;
            }

            // --- GENERAL MODIFIERS ---
            if (scenario === 'optimistic') {
                res.mods = { pe: 1.1, margin: 1.03, growth: 1.1 };
            } else if (scenario === 'pessimistic') {
                res.mods = { pe: 0.9, margin: 0.97, growth: 0.85 };
            }

            return res;
        }

        // --- IRR ---
        function calculateIRR(values) {
            const hasPos = values.some(v => v > 0);
            const hasNeg = values.some(v => v < 0);
            if (!hasPos || !hasNeg) return null; 
            const maxIter = CONFIG.IRR_MAX_ITER, tol = CONFIG.IRR_TOL;
            let rate = 0.1;

            for (let i = 0; i < maxIter; i++) {
                let npv = 0, d_npv = 0;
                const onePlus = 1 + rate;
                if (onePlus <= 0) break;
                for (let j = 0; j < values.length; j++) {
                    const div = Math.pow(onePlus, j);
                    npv += values[j] / div;
                    d_npv -= (j * values[j]) / (div * onePlus);
                }
                if (Math.abs(npv) < tol) return rate;
                if (d_npv === 0 || !isFinite(d_npv)) break;
                const newRate = rate - (npv / d_npv);
                if (!isFinite(newRate)) break;
                if (Math.abs(newRate - rate) < tol) return newRate;
                rate = newRate;
                if (rate < CONFIG.IRR_MIN_RATE || rate > CONFIG.IRR_MAX_RATE) break;
            }
            return null; 
        }

        // --- CORE MODEL ---
        function runDCFModel(inputs, userThemeKey, scenario, overrides = {}) {
            const { startPrice, startRPS, startGrowth, forecastMargin, wacc, startPayout, N } = inputs;
            const params = getCalcParams(userThemeKey, scenario, state.currentTicker);
            const mods = params.mods;
            const chainKeys = params.chain;

            const t1 = METRICS[chainKeys[0]];
            const t2 = METRICS[chainKeys[1]];
            const t3 = METRICS[chainKeys[2]];

            const WEIGHTS = { optimistic: { mid: 0.3 }, base: { mid: 0.5 }, pessimistic:{ mid: 0.8 } };
            const w = WEIGHTS[scenario] || WEIGHTS.base;
            const blend = (curr, target, weight) => curr * (1 - weight) + target * weight;

            const rawG = (m) => m.growth * mods.growth;
            const rawM = (m) => m.margin * mods.margin;
            
            const isRocket = (userThemeKey === 'Rocket');
            const t3Effective = isRocket ? METRICS['Expansion'] : t3;
            const TERM_BLEND = 0.7; 
            const rawGBase = (m) => m.growth; 
            const rawMBase = (m) => m.margin;

            const targetTerm = {
                g: blend(startGrowth, rawGBase(t3Effective), TERM_BLEND),
                m: blend(forecastMargin, rawMBase(t3Effective), TERM_BLEND),
                p: isRocket ? t3Effective.payout : blend(startPayout, t3Effective.payout, TERM_BLEND)
            };
            const targetMid = {
                g: blend(startGrowth, rawG(t1), w.mid),
                m: blend(forecastMargin, rawM(t1), w.mid),
                p: (isRocket ? METRICS['Expansion'].payout : blend(startPayout, t1.payout, w.mid))
            };

            const phaseTargets = { current: { g: startGrowth, m: forecastMargin, p: startPayout }, mid: targetMid, term: targetTerm };

            const modelYears = Math.max(1, N - CONFIG.ANALYST_YEARS);
            let p1_dur = Math.floor(modelYears / 3);
            let p2_dur = Math.floor(modelYears / 3);
            
            const highGrowthProfiles = ['Rocket', 'Expansion'];
            if (highGrowthProfiles.includes(params.themeKey)) {
                const maxHigh = 5; 
                const total12 = p1_dur + p2_dur;
                if (total12 > maxHigh) {
                    const scale = maxHigh / total12;
                    p1_dur = Math.max(1, Math.round(p1_dur * scale));
                    p2_dur = Math.max(1, Math.round(p2_dur * scale));
                }
            } else {
                 p1_dur = Math.min(5, p1_dur);
                 p2_dur = Math.min(5, p2_dur);
            }
            let p3_dur = modelYears - p1_dur - p2_dur;

            // --- TERMINAL P/S & P/E LOGIC ---
            const tickerData = GLOBAL_DB[state.currentTicker] || {};
            const termParams = getTerminalParams(userThemeKey, scenario, state.currentTicker);
            const termTheme = METRICS[termParams.themeKey];
            const scenarioAdj = termParams.adj;

            // FIX: CALCULATE PREMIUM DYNAMICALLY FROM INPUTS
            // This ensures manual input changes reflect in valuation premium immediately
            let currentInputPS = 0;
            if (startRPS > 0) {
                currentInputPS = startPrice / startRPS;
            }

            let psPremium = 1.0;
            const baseMetricPS = METRICS[userThemeKey].ps; 
            
            // Prefer current input P/S for premium calc if available
            if (currentInputPS > 0 && baseMetricPS > 0) {
                psPremium = currentInputPS / baseMetricPS;
            } 
            // Fallback to DB stored PS if for some reason inputs are broken (unlikely)
            else if (tickerData.ps && baseMetricPS) {
                psPremium = tickerData.ps / baseMetricPS;
            } else if (tickerData.pe && METRICS[userThemeKey].pe) {
                psPremium = tickerData.pe / METRICS[userThemeKey].pe; 
            }
            
            psPremium = clamp(psPremium, 0.5, 2.0);
            
            const finalPremium = 1 + (psPremium - 1) * 0.5;

            // Run loop first
            let rps = startRPS, pvDiv = 0, irrStream = [-startPrice], tableData = [];
            const eps0 = startRPS * (forecastMargin / 100);
            
            tableData.push({ year: 0, phase: 'Start', rps: startRPS, margin: forecastMargin, eps: eps0, flow: -startPrice, payout: startPayout, isExit: false });

            const y_p1_end = CONFIG.ANALYST_YEARS + p1_dur;
            const y_p2_end = y_p1_end + p2_dur;

            // --- DISCOUNTING SETUP with TAIL PENALTY ---
            let df = 1.0;

            for (let i = 1; i <= N; i++) {
                let g, m, pay, phaseLabel = "Analyst";

                if (['SPY', 'QQQ', 'DIA'].includes(state.currentTicker)) {
                     phaseLabel = "Index Flow";
                     const progressG = Math.min(1, (i - 1) / 10); 
                     const progressP = Math.min(1, (i - 1) / 15); 
                     const termG = 6.5; const termP = 40.0; 
                     g = startGrowth - (startGrowth - termG) * progressG;
                     m = forecastMargin; 
                     pay = startPayout - (startPayout - termP) * progressP;
                     phaseTargets.term = { g: termG, m: forecastMargin, p: termP };
                } else {
                    if (i <= CONFIG.ANALYST_YEARS) {
                        g = startGrowth; m = forecastMargin; pay = startPayout;
                    } else {
                        let progress = 0;
                        if (i <= y_p1_end) {
                            phaseLabel = "Phase 1";
                            progress = (i - CONFIG.ANALYST_YEARS) / Math.max(1, p1_dur);
                            g = startGrowth + (targetMid.g - startGrowth) * progress;
                            m = forecastMargin + (targetMid.m - forecastMargin) * progress;
                            pay = startPayout + (targetMid.p - startPayout) * progress;
                        } else if (i <= y_p2_end) {
                            phaseLabel = "Phase 2";
                            progress = (i - y_p1_end) / Math.max(1, p2_dur);
                            g = targetMid.g + (targetTerm.g - targetMid.g) * progress;
                            m = targetMid.m + (targetTerm.m - targetMid.m) * progress;
                            pay = targetMid.p + (targetTerm.p - targetMid.p) * progress;
                        } else {
                            phaseLabel = "Phase 3";
                            g = targetTerm.g;
                            m = targetTerm.m;
                            pay = targetTerm.p;
                        }
                    }
                }
                pay = clamp(pay, 0, 100);
                rps = rps * (1 + g / 100);
                let eps = rps * (m / 100);
                let div = (eps > 0 ? eps : 0) * (pay / 100);
                let effectiveRate = wacc;
                if (i > TAIL_PENALTY.START_YEAR) effectiveRate += TAIL_PENALTY.EXTRA_DR;
                df *= (1 + effectiveRate);
                pvDiv += div / df;
                irrStream.push(div);
                tableData.push({ year: i, phase: phaseLabel, rps: rps, margin: m, eps: eps, flow: div, payout: pay, isExit: false });
            }

            // Calculate Final P/S and P/E
            let finalPS = termTheme.ps * finalPremium * scenarioAdj;
            
            // Safety caps
            let maxPE = 80;
            if (scenario === 'base') maxPE = 30;       // Base case shouldn't bet on >30x exit
            if (scenario === 'pessimistic') maxPE = 20; // Pessimistic cap
            
            let finalPE = finalPS / safeMarginDec;
            
            // Apply PE Cap and recalc PS to match
            if (finalPE > maxPE) {
                finalPE = maxPE;
                finalPS = finalPE * safeMarginDec;
            }
            
            // Clamp lower bounds
            finalPS = Math.max(finalPS, 0.5);
            finalPE = Math.max(finalPE, 5);

            // Override if matrix asked for specific PE
            if (overrides.finalPE !== undefined) {
                finalPE = overrides.finalPE;
                finalPS = finalPE * safeMarginDec; 
            }

            // Exit Price
            const exitPricePE = lastData.eps * finalPE;
            const exitPricePS = lastData.rps * finalPS;
            const exitPrice = (exitPricePE + exitPricePS) / 2;
            const exitDiff = (exitPrice > 0) ? (exitPricePS - exitPricePE) / exitPrice : 0;

            if (lastData.eps > 0) {
                irrStream[irrStream.length - 1] += exitPrice;
                tableData.push({
                    year: N,
                    phase: 'EXIT',
                    rps: lastData.rps,
                    margin: lastData.margin,
                    eps: lastData.eps,
                    flow: exitPrice,
                    payout: null,
                    isExit: true,
                    finalPE: finalPE,
                    finalPS: finalPS,
                    exitDiff: exitDiff
                });
            }

            const pvExit = exitPrice / df;
            const fv = pvDiv + pvExit;
            const irr = calculateIRR(irrStream);
            let upside = null; if (startPrice > 0 && isFinite(fv)) upside = ((fv - startPrice) / startPrice) * 100;
            let spread = null; if (irr != null) spread = (irr - wacc) * 100;

            return { tableData, irrStream, irr, wacc, fv, pvDiv, pvExit, upside, spread, finalPE, finalPS, phaseTargets, themeLCX: METRICS[params.themeKey].lcX, inputs };
        }

        // --- RENDERING ---
        function renderSummary(result, inputs) {
            const { irr, wacc, fv, upside, spread, finalPE, finalPS } = result;
            safeSetText('disp-years', inputs.N + ' лет');
            const irrEl = document.getElementById('res-irr');
            if (irr == null) {
                irrEl.innerText = 'n/a';
                irrEl.className = "text-5xl font-bold tracking-tight text-slate-300";
            } else {
                irrEl.innerText = (irr * 100).toFixed(1) + '%';
                irrEl.className = (irr >= wacc) ? "text-5xl font-bold tracking-tight text-green-400" : "text-5xl font-bold tracking-tight text-yellow-400";
                if (irr * 100 > 40 && inputs.startGrowth < 25) irrEl.className = "text-5xl font-bold tracking-tight text-orange-400"; 
            }
            const upEl = document.getElementById('res-upside');
            upEl.innerText = upside == null ? 'n/a' : (upside > 0 ? '+' : '') + upside.toFixed(1) + '%';
            if (upside != null && upside < 0) upEl.className = "text-xl font-bold text-red-400";
            else upEl.className = "text-xl font-bold text-green-400";

            safeSetText('res-fv', formatCurrency(fv));
            safeSetText('res-exit-pe', isFinite(finalPE) ? finalPE.toFixed(1) + 'x' : '--x');
            
            // NEW: Display Exit PS
            const psEl = document.getElementById('res-exit-ps');
            if(psEl) psEl.innerText = isFinite(finalPS) ? finalPS.toFixed(1) + 'x' : '--x';
        }

        function renderSensitivity(baseResult, baseInputs, theme, scenario) {
            const gridEl = document.getElementById('sens-grid');
            if (!gridEl) return;
            gridEl.innerHTML = '';
            const waccStep = 0.01, peStep = 1.0;
            const currentPE = baseResult.finalPE, currentWACC = baseResult.wacc;
            const peLabels = [
                { label: 'r \\ PE', class: 'text-slate-500' },
                { label: '-1.0x', val: currentPE - peStep },
                { label: 'Base',  val: currentPE },
                { label: '+1.0x', val: currentPE + peStep }
            ];
            peLabels.forEach((h, i) => {
                const div = document.createElement('div');
                div.className = "text-[10px] font-bold pb-1 " + (i===0 ? h.class : (i===2 ? "text-blue-600" : "text-slate-500"));
                div.innerText = h.label;
                gridEl.appendChild(div);
            });
            const waccRows = [ { label: '+1.0%', val: currentWACC + waccStep }, { label: 'Base', val: currentWACC }, { label: '-1.0%', val: currentWACC - waccStep } ];
            waccRows.forEach(row => {
                const rowHeader = document.createElement('div');
                rowHeader.className = "text-[10px] font-bold my-auto text-left pl-1 " + (row.label==='Base' ? "text-blue-600" : "text-slate-500");
                rowHeader.innerText = row.label;
                gridEl.appendChild(rowHeader);
                peLabels.slice(1).forEach(col => {
                    const simInputs = { ...baseInputs, wacc: row.val };
                    const simResult = runDCFModel(simInputs, theme, scenario, { finalPE: col.val });
                    const cell = document.createElement('div');
                    
                    // Calculate Upside
                    const price = baseInputs.startPrice;
                    const fv = simResult.fv;
                    const upside = price > 0 ? ((fv - price) / price) * 100 : 0;
                    const sign = upside > 0 ? '+' : '';
                    
                    const isBase = (row.label === 'Base' && col.label === 'Base');
                    let bgClass = "bg-slate-50";
                    let textClass = "text-slate-600";
                    
                    if (isBase) {
                        bgClass = "bg-blue-600 shadow-lg z-10 ring-2 ring-blue-300";
                        textClass = "text-white";
                    } else {
                        if (upside > 5) { bgClass = "bg-green-100"; textClass = "text-green-800"; }
                        else if (upside < -5) { bgClass = "bg-red-50"; textClass = "text-red-800"; }
                    }

                    cell.className = `p-1 rounded-sm cursor-default flex flex-col items-center justify-center ${bgClass} ${textClass} text-[10px] leading-tight`;
                    
                    cell.innerHTML = `
                        <div class="font-bold">$${fv.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                        <div class="text-[9px] opacity-80">${sign}${upside.toFixed(0)}%</div>
                    `;
                    
                    gridEl.appendChild(cell);
                });
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                
                if (row.isExit) {
                    tr.className = "bg-indigo-100 font-bold border-t-2 border-indigo-200";
                    // UPDATED: Dual formula display
                    tr.innerHTML = `
                        <td class="px-4 py-2 font-medium text-indigo-900">${row.year}</td>
                        <td class="px-4 py-2 text-xs font-bold text-indigo-700">ПРОДАЖА</td>
                        <td class="px-4 py-2 text-right">
                            <div class="text-[10px] text-slate-500">RPS x P/S</div>
                            <div class="font-mono text-indigo-800">${formatCurrency(row.rps)} x ${row.finalPS.toFixed(1)}x</div>
                        </td>
                         <td class="px-4 py-2 text-right">
                            <div class="text-[10px] text-slate-500">EPS x P/E</div>
                            <div class="font-mono text-indigo-800">${formatCurrency(row.eps)} x ${row.finalPE.toFixed(1)}x</div>
                        </td>
                        <td class="px-4 py-2 text-right text-indigo-400" colspan="2">=</td>
                        <td class="px-4 py-2 text-right font-bold text-indigo-700 text-lg">${formatCurrency(row.flow)}</td>
                    `;
                } else {
                    if (row.phase === 'Analyst' || row.phase === 'Start') tr.className = "bg-amber-50 border-l-4 border-amber-300";
                    else tr.className = "hover:bg-slate-50 border-l-4 border-indigo-300";
                    
                    const usd = n => formatCurrency(n);
                    const pct = n => formatPercent(n);
                    const payoutTxt = row.year === 0 ? '-' : (row.payout != null ? row.payout.toFixed(0) + '%' : '-');

                    tr.innerHTML = `
                        <td class="px-4 py-2 font-medium text-slate-900">${row.year}</td>
                        <td class="px-4 py-2 text-xs font-bold text-slate-500">${row.phase}</td>
                        <td class="px-4 py-2 text-right text-slate-500">${row.year===0 ? '-' : usd(row.rps)}</td>
                        <td class="px-4 py-2 text-right text-slate-500">${row.year===0 ? '-' : pct(row.margin)}</td>
                        <td class="px-4 py-2 text-right text-slate-500">${row.year===0 ? '-' : usd(row.eps)}</td>
                        <td class="px-4 py-2 text-right text-purple-600 font-mono">${payoutTxt}</td>
                        <td class="px-4 py-2 text-right ${row.flow<0?'text-red-600':'text-blue-600'}">${usd(row.flow)}</td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }

        function renderLifecycleVisuals(result, themeKey, scenario) {
            // 1. Table
            const t = result.phaseTargets;
            const tbody = document.getElementById('lifecycle-table-body');
            tbody.innerHTML = `
                <tr class="border-b border-slate-50">
                    <td class="py-2 pl-2 text-slate-600">CAGR Рост</td>
                    <td class="py-2 text-right text-slate-500">${t.current.g.toFixed(1)}%</td>
                    <td class="py-2 text-right text-blue-600 font-bold bg-blue-50/50 rounded">${t.mid.g.toFixed(1)}%</td>
                    <td class="py-2 text-right text-slate-400">${t.term.g.toFixed(1)}%</td>
                </tr>
                <tr class="border-b border-slate-50">
                    <td class="py-2 pl-2 text-slate-600">Маржа</td>
                    <td class="py-2 text-right text-slate-500">${t.current.m.toFixed(1)}%</td>
                    <td class="py-2 text-right text-blue-600 font-bold bg-blue-50/50 rounded">${t.mid.m.toFixed(1)}%</td>
                    <td class="py-2 text-right text-slate-400">${t.term.m.toFixed(1)}%</td>
                </tr>
                <tr>
                    <td class="py-2 pl-2 text-slate-600">Payout</td>
                    <td class="py-2 text-right text-slate-500">${t.current.p.toFixed(0)}%</td>
                    <td class="py-2 text-right text-blue-600 font-bold bg-blue-50/50 rounded">${t.mid.p.toFixed(0)}%</td>
                    <td class="py-2 text-right text-slate-400">${t.term.p.toFixed(0)}%</td>
                </tr>
            `;

            // 2. Chart
            if (!state.charts.lc) return;
            const chart = state.charts.lc;
            
            const baseX = METRICS[themeKey].lcX; 
            
            const pX = Math.min(100, baseX + 15);
            const oX = Math.max(0, baseX - 15);
            
            const bell = (x) => 100 * Math.exp(-Math.pow(x - 40, 2) / (2 * Math.pow(25, 2))); 
            
            // Fixed reference points for ETFs
            const etfData = [
                { x: METRICS['IndexTech'].lcX, y: bell(METRICS['IndexTech'].lcX), label: 'QQQ' },
                { x: METRICS['Steady'].lcX, y: bell(METRICS['Steady'].lcX), label: 'SPY' },
                { x: METRICS['IndexValue'].lcX, y: bell(METRICS['IndexValue'].lcX), label: 'DIA' }
            ];

            // Background theme markers
            const themeData = THEME_ORDER.map(k => ({
                x: METRICS[k].lcX,
                y: bell(METRICS[k].lcX)
            }));
            
            // Update Datasets
            // 0: Curve, 1: All Themes (Gray), 2: ETFs (Square), 3: Target Company (Big Circle)
            
            chart.data.datasets[1].data = themeData; 
            chart.data.datasets[2].data = etfData;
            
            // Target Company Position based on Scenario
            let activeX = baseX;
            let color = '#3b82f6'; // Base Blue
            if (scenario === 'optimistic') { activeX = oX; color = '#22c55e'; }
            if (scenario === 'pessimistic') { activeX = pX; color = '#ef4444'; }
            
            chart.data.datasets[3].data = [{x: activeX, y: bell(activeX)}]; 
            chart.data.datasets[3].backgroundColor = color;
            
            chart.update();
        }

        // --- CHARTS ---
        function initChart() {
            // Lifecycle Chart Only
            const ctxLc = document.getElementById('lifecycleChart');
            if (ctxLc) {
                const curveData = [];
                for(let i=0; i<=100; i+=2) {
                    const y = 100 * Math.exp(-Math.pow(i - 40, 2) / (2 * Math.pow(25, 2)));
                    curveData.push({x: i, y: y});
                }

                state.charts.lc = new Chart(ctxLc.getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Lifecycle',
                                data: curveData,
                                borderColor: '#cbd5e1',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true,
                                backgroundColor: 'rgba(241, 245, 249, 0.5)',
                                tension: 0.4
                            },
                            { 
                                label: 'Themes', 
                                data: [], 
                                backgroundColor: '#94a3b8', 
                                pointRadius: 3, 
                                type: 'scatter' 
                            },
                            { 
                                label: 'ETFs', 
                                data: [], 
                                backgroundColor: '#6366f1', 
                                pointRadius: 6, 
                                pointStyle: 'rectRot',
                                type: 'scatter' 
                            }, 
                            { 
                                label: 'Company', 
                                data: [], 
                                backgroundColor: '#3b82f6', 
                                pointRadius: 10, 
                                type: 'scatter' 
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false }, 
                            tooltip: { 
                                enabled: true,
                                callbacks: {
                                    label: function(context) {
                                        // Custom logic to show ETF names if available in raw data
                                        const raw = context.raw;
                                        if (raw.label) return raw.label;
                                        return context.dataset.label;
                                    }
                                }
                            } 
                        },
                        scales: {
                            x: { type: 'linear', display: true, min: 0, max: 100, title: {display: true, text: 'Стадии: Старт -> Рост -> Зрелость -> Спад'} },
                            y: { display: false, min: 0, max: 110 }
                        }
                    }
                });
            }
        }

        // --- MAIN ---
        function readInputsFromDOM() {
            const getVal = (id) => parseFloat(document.getElementById(id).value);
            const waccInput = getVal('inp-wacc'); 
            return {
                startPrice: getVal('inp-price') || 0,
                startRPS: getVal('inp-rps') || 0,
                startGrowth: getVal('inp-growth') || 0,
                forecastMargin: getVal('inp-forecast-margin') || 0,
                // Check isNaN so 0 is allowed
                wacc: (isNaN(waccInput) ? 8 : waccInput)/100,
                startPayout: getVal('inp-payout') || 0,
                N: parseInt(document.getElementById('slider-years').value) || 15
            };
        }

        function calculate() {
            const userTheme = document.getElementById('theme-selector').value;
            const inputs = readInputsFromDOM();
            
            const result = runDCFModel(inputs, userTheme, state.scenario);
            renderSummary(result, inputs);
            renderTable(result.tableData);
            renderSensitivity(result, inputs, userTheme, state.scenario);
            
            renderLifecycleVisuals(result, userTheme, state.scenario);
        }

        function setScenario(s) {
            const themeKey = document.getElementById('theme-selector').value;
            state.scenario = s;
            ['pessimistic', 'base', 'optimistic'].forEach(id => {
                const btn = document.getElementById('btn-' + id);
                if (!btn) return;
                const isAct = (id === s);
                if (id === 'pessimistic') btn.className = isAct ? "flex-1 py-3 text-xs bg-red-100 text-red-800 border-red-300 rounded-lg shadow-inner font-bold border" : "flex-1 py-3 text-xs border rounded-lg hover:bg-slate-50 transition-all font-medium text-slate-600";
                else if (id === 'optimistic') btn.className = isAct ? "flex-1 py-3 text-xs bg-green-100 text-green-800 border-green-300 rounded-lg shadow-inner font-bold border" : "flex-1 py-3 text-xs border rounded-lg hover:bg-green-50 transition-all font-medium text-slate-600";
                else btn.className = isAct ? "flex-1 py-3 text-xs bg-blue-600 text-white rounded-lg shadow-md font-bold" : "flex-1 py-3 text-xs border rounded-lg hover:bg-slate-50 transition-all font-medium text-slate-600";
            });
            const params = getCalcParams(themeKey, s);
            const slider = document.getElementById('slider-years');
            if (slider && !state.userSetYears) {
                const baseN = METRICS[params.themeKey].N || 12;
                slider.value = getScenarioHorizon(baseN, s);
            }
            calculate();
        }

        // --- INIT ---
        window.addEventListener('load', () => {
            initChart();
            setScenario('base');
        });

        // Listeners
        document.getElementById('inp-ticker').addEventListener('keypress', (e) => { if(e.key==='Enter') loadTicker(); });
        document.getElementById('theme-selector').addEventListener('change', () => setScenario(state.scenario || 'base'));
        document.getElementById('slider-years').addEventListener('input', () => { state.userSetYears = true; calculate(); });
        ['inp-price', 'inp-rps', 'inp-growth', 'inp-forecast-margin', 'inp-wacc', 'inp-payout'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculate);
        });
    </script>
</body>
</html>
